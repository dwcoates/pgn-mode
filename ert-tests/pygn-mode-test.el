;; -*- lexical-binding: t -*-

(require 'pygn-mode)

(eval-when-compile
  (require 'subr-x))

(setq pygn-mode-test-containing-directory
      (file-name-directory
       (or load-file-name
           (bound-and-true-p byte-compile-current-file)
           (buffer-file-name (current-buffer)))))

(setq pygn-mode-test-input-directory
      (expand-file-name "test-input" pygn-mode-test-containing-directory))

(setq pygn-mode-test-output-directory
      (expand-file-name "test-output" pygn-mode-test-containing-directory))

;; not move number in the chess sense, but ply
(setq pygn-mode-test-01-move-start-positions '(( 1 . 181)
                                               ( 2 . 186)
                                               ( 3 . 277)
                                               ( 4 . 282)
                                               ( 5 . 455)
                                               ( 6 . 459)
                                               ( 7 . 612)
                                               ( 8 . 616)
                                               ( 9 . 795)
                                               (10 . 800)))

;; not move number in the chess sense, but ply
(setq pygn-mode-test-01-move-after-positions '(( 1 . 185)
                                               ( 2 . 189)
                                               ( 3 . 281)
                                               ( 4 . 286)
                                               ( 5 . 458)
                                               ( 6 . 462)
                                               ( 7 . 615)
                                               ( 8 . 620)
                                               ( 9 . 799)
                                               (10 . 802)))

;; not move number in the chess sense, but ply
;; the fen is inclusive of the move itself
(setq pygn-mode-test-01-move-fens '(( 1 . "r1bRQ3/ppp3pp/4p1k1/2b1P1n1/1np1q3/5N2/PPP3PP/5R1K b - - 3 18")
                                    ( 2 . "r1bRQ3/ppp3pp/4p2k/2b1P1n1/1np1q3/5N2/PPP3PP/5R1K w - - 4 19" )
                                    ( 3 . "r1bRQ3/ppp3pp/4p2k/2b1P1N1/1np1q3/8/PPP3PP/5R1K b - - 0 19"   )
                                    ( 4 . "r1bRQ3/ppp3pp/4p3/2b1P1k1/1np1q3/8/PPP3PP/5R1K w - - 0 20"    )
                                    ( 5 . "r1bR4/ppp2Qpp/4p3/2b1P1k1/1np1q3/8/PPP3PP/5R1K b - - 1 20"    )
                                    ( 6 . "r1bR4/ppp2Qpp/4p1q1/2b1P1k1/1np5/8/PPP3PP/5R1K w - - 2 21"    )
                                    ( 7 . "r1b3R1/ppp2Qpp/4p1q1/2b1P1k1/1np5/8/PPP3PP/5R1K b - - 3 21"   )
                                    ( 8 . "r1b3R1/ppp2qpp/4p3/2b1P1k1/1np5/8/PPP3PP/5R1K w - - 0 22"     )
                                    ( 9 . "r1b3R1/ppp2Rpp/4p3/2b1P1k1/1np5/8/PPP3PP/7K b - - 0 22"       )
                                    (10 . "r1b3R1/ppp2R1p/4p1p1/2b1P1k1/1np5/8/PPP3PP/7K w - - 0 23"     )))

;; not move number in the chess sense, but ply
(setq pygn-mode-test-02-move-start-positions '(( 1 .  268)
                                               ( 2 .  271)
                                               ( 3 .  278)
                                               ( 4 .  281)
                                               ( 5 .  287)
                                               ( 6 .  291)
                                               ( 7 .  298)
                                               ( 8 .  301)
                                               ( 9 .  307)
                                               (10 .  310)
                                               (11 .  317)
                                               (12 .  320)
                                               (13 .  328)
                                               (14 .  333)
                                               (15 .  339)
                                               (16 .  613)
                                               (17 .  621)
                                               (18 .  626)
                                               (19 .  635)
                                               (20 .  641)
                                               (21 .  650)
                                               (22 .  748)
                                               (23 . 1100)
                                               (24 . 1171)
                                               (25 . 1181)
                                               (26 . 1186)
                                               (27 . 1235)
                                               (28 . 1452)
                                               (29 . 1576)
                                               (30 . 1739)
                                               (31 . 1747)
                                               (32 . 2209)
                                               (33 . 2217)
                                               (34 . 2404)
                                               (35 . 2413)
                                               (36 . 2418)
                                               (37 . 2514)
                                               (38 . 2518)
                                               (39 . 2525)
                                               (40 . 2684)
                                               (41 . 2692)
                                               (42 . 2697)
                                               (43 . 2706)
                                               (44 . 2711)
                                               (45 . 2800)
                                               (46 . 2861)
                                               (47 . 2868)
                                               (48 . 3052)
                                               (49 . 3061)
                                               (50 . 3065)
                                               (51 . 3177)
                                               (52 . 3181)
                                               (53 . 3190)
                                               (54 . 3195)
                                               (55 . 3203)
                                               (56 . 3206)
                                               (57 . 3277)
                                               (58 . 3280)
                                               (59 . 3287)
                                               (60 . 3292)
                                               (61 . 3301)
                                               (62 . 3396)
                                               (63 . 3404)
                                               (64 . 3408)
                                               (65 . 3417)
                                               (66 . 3482)
                                               (67 . 3917)
                                               (68 . 3921)
                                               (69 . 3929)
                                               (70 . 3933)
                                               (71 . 3941)
                                               (72 . 3945)
                                               (73 . 4041)
                                               (74 . 4045)
                                               (75 . 4053)
                                               (76 . 4057)
                                               (77 . 4065)
                                               (78 . 4069)
                                               (79 . 4111)
                                               (80 . 4115)
                                               (81 . 4123)
                                               (82 . 4127)
                                               (83 . 4135)
                                               (84 . 4139)
                                               (85 . 4171)
                                               (86 . 4300)
                                               (87 . 4308)
                                               (88 . 4312)
                                               (89 . 4468)
                                               (90 . 4538)
                                               (91 . 4546)
                                               (92 . 4550)
                                               (93 . 4603)
                                               (94 . 4676)))

;; not move number in the chess sense, but ply
(setq pygn-mode-test-02-move-after-positions '(( 1 .  270)
                                               ( 2 .  274)
                                               ( 3 .  280)
                                               ( 4 .  283)
                                               ( 5 .  290)
                                               ( 6 .  294)
                                               ( 7 .  300)
                                               ( 8 .  303)
                                               ( 9 .  309)
                                               (10 .  313)
                                               (11 .  319)
                                               (12 .  324)
                                               (13 .  332)
                                               (14 .  335)
                                               (15 .  341)
                                               (16 .  617)
                                               (17 .  625)
                                               (18 .  630)
                                               (19 .  640)
                                               (20 .  645)
                                               (21 .  653)
                                               (22 .  751)
                                               (23 . 1103)
                                               (24 . 1176)
                                               (25 . 1185)
                                               (26 . 1189)
                                               (27 . 1238)
                                               (28 . 1455)
                                               (29 . 1578)
                                               (30 . 1742)
                                               (31 . 1750)
                                               (32 . 2212)
                                               (33 . 2222)
                                               (34 . 2408)
                                               (35 . 2417)
                                               (36 . 2422)
                                               (37 . 2517)
                                               (38 . 2520)
                                               (39 . 2529)
                                               (40 . 2687)
                                               (41 . 2696)
                                               (42 . 2701)
                                               (43 . 2710)
                                               (44 . 2713)
                                               (45 . 2803)
                                               (46 . 2863)
                                               (47 . 2871)
                                               (48 . 3056)
                                               (49 . 3064)
                                               (50 . 3067)
                                               (51 . 3180)
                                               (52 . 3185)
                                               (53 . 3194)
                                               (54 . 3198)
                                               (55 . 3205)
                                               (56 . 3208)
                                               (57 . 3279)
                                               (58 . 3282)
                                               (59 . 3291)
                                               (60 . 3296)
                                               (61 . 3305)
                                               (62 . 3399)
                                               (63 . 3407)
                                               (64 . 3412)
                                               (65 . 3420)
                                               (66 . 3485)
                                               (67 . 3920)
                                               (68 . 3924)
                                               (69 . 3932)
                                               (70 . 3936)
                                               (71 . 3944)
                                               (72 . 3948)
                                               (73 . 4044)
                                               (74 . 4048)
                                               (75 . 4056)
                                               (76 . 4060)
                                               (77 . 4068)
                                               (78 . 4072)
                                               (79 . 4114)
                                               (80 . 4118)
                                               (81 . 4126)
                                               (82 . 4130)
                                               (83 . 4138)
                                               (84 . 4142)
                                               (85 . 4174)
                                               (86 . 4303)
                                               (87 . 4311)
                                               (88 . 4315)
                                               (89 . 4471)
                                               (90 . 4541)
                                               (91 . 4549)
                                               (92 . 4554)
                                               (93 . 4606)
                                               (94 . 4679)))

;; not move number in the chess sense, but ply
;; the fen is inclusive of the move itself
(setq pygn-mode-test-02-move-fens '(( 1 . "rnbqkbnr/pppppppp/8/8/3P4/8/PPP1PPPP/RNBQKBNR b KQkq - 0 1"         )
                                    ( 2 . "rnbqkb1r/pppppppp/5n2/8/3P4/8/PPP1PPPP/RNBQKBNR w KQkq - 1 2"       )
                                    ( 3 . "rnbqkb1r/pppppppp/5n2/8/2PP4/8/PP2PPPP/RNBQKBNR b KQkq - 0 2"       )
                                    ( 4 . "rnbqkb1r/pppp1ppp/4pn2/8/2PP4/8/PP2PPPP/RNBQKBNR w KQkq - 0 3"      )
                                    ( 5 . "rnbqkb1r/pppp1ppp/4pn2/8/2PP4/2N5/PP2PPPP/R1BQKBNR b KQkq - 1 3"    )
                                    ( 6 . "rnbqk2r/pppp1ppp/4pn2/8/1bPP4/2N5/PP2PPPP/R1BQKBNR w KQkq - 2 4"    )
                                    ( 7 . "rnbqk2r/pppp1ppp/4pn2/8/1bPP4/2N2P2/PP2P1PP/R1BQKBNR b KQkq - 0 4"  )
                                    ( 8 . "rnbqk2r/ppp2ppp/4pn2/3p4/1bPP4/2N2P2/PP2P1PP/R1BQKBNR w KQkq - 0 5" )
                                    ( 9 . "rnbqk2r/ppp2ppp/4pn2/3p4/1bPP4/P1N2P2/1P2P1PP/R1BQKBNR b KQkq - 0 5")
                                    (10 . "rnbqk2r/ppp1bppp/4pn2/3p4/2PP4/P1N2P2/1P2P1PP/R1BQKBNR w KQkq - 1 6")
                                    (11 . "rnbqk2r/ppp1bppp/4pn2/3p4/2PPP3/P1N2P2/1P4PP/R1BQKBNR b KQkq - 0 6" )
                                    (12 . "rnbqk2r/ppp1bppp/4pn2/8/2PPp3/P1N2P2/1P4PP/R1BQKBNR w KQkq - 0 7"   )
                                    (13 . "rnbqk2r/ppp1bppp/4pn2/8/2PPP3/P1N5/1P4PP/R1BQKBNR b KQkq - 0 7"     )
                                    (14 . "rnbqk2r/pp2bppp/4pn2/2p5/2PPP3/P1N5/1P4PP/R1BQKBNR w KQkq - 0 8"    )
                                    (15 . "rnbqk2r/pp2bppp/4pn2/2p1P3/2PP4/P1N5/1P4PP/R1BQKBNR b KQkq - 0 8"   )
                                    (16 . "rnbqk2r/pp1nbppp/4p3/2p1P3/2PP4/P1N5/1P4PP/R1BQKBNR w KQkq - 1 9"   )
                                    (17 . "rnbqk2r/pp1nbppp/4p3/2P1P3/2P5/P1N5/1P4PP/R1BQKBNR b KQkq - 0 9"    )
                                    (18 . "rnbqk2r/pp2bppp/4p3/2P1n3/2P5/P1N5/1P4PP/R1BQKBNR w KQkq - 0 10"    )
                                    (19 . "rnbQk2r/pp2bppp/4p3/2P1n3/2P5/P1N5/1P4PP/R1B1KBNR b KQkq - 0 10"    )
                                    (20 . "rnbbk2r/pp3ppp/4p3/2P1n3/2P5/P1N5/1P4PP/R1B1KBNR w KQkq - 0 11"     )
                                    (21 . "rnbbk2r/pp3ppp/4p3/2P1n3/2P5/P1N5/1P2B1PP/R1B1K1NR b KQkq - 1 11"   )
                                    (22 . "rn1bk2r/pp1b1ppp/4p3/2P1n3/2P5/P1N5/1P2B1PP/R1B1K1NR w KQkq - 2 12" )
                                    (23 . "rn1bk2r/pp1b1ppp/4p3/2P1n3/2P5/P1N2N2/1P2B1PP/R1B1K2R b KQkq - 3 12")
                                    (24 . "rn1bk2r/pp1b1ppp/4p3/2P5/2P5/P1N2n2/1P2B1PP/R1B1K2R w KQkq - 0 13"  )
                                    (25 . "rn1bk2r/pp1b1ppp/4p3/2P5/2P5/P1N2B2/1P4PP/R1B1K2R b KQkq - 0 13"    )
                                    (26 . "rn1bk2r/pp3ppp/2b1p3/2P5/2P5/P1N2B2/1P4PP/R1B1K2R w KQkq - 1 14"    )
                                    (27 . "rn1bk2r/pp3ppp/2b1p3/2P5/2P1N3/P4B2/1P4PP/R1B1K2R b KQkq - 2 14"    )
                                    (28 . "rn2k2r/ppb2ppp/2b1p3/2P5/2P1N3/P4B2/1P4PP/R1B1K2R w KQkq - 3 15"    )
                                    (29 . "rn2k2r/ppb2ppp/2b1p3/2P5/1PP1N3/P4B2/6PP/R1B1K2R b KQkq - 0 15"     )
                                    (30 . "r3k2r/ppbn1ppp/2b1p3/2P5/1PP1N3/P4B2/6PP/R1B1K2R w KQkq - 1 16"     )
                                    (31 . "r3k2r/ppbn1ppp/2b1p3/2P5/1PP1N3/P4B2/1B4PP/R3K2R b KQkq - 2 16"     )
                                    (32 . "r3k2r/ppb2ppp/2b1p3/2P1n3/1PP1N3/P4B2/1B4PP/R3K2R w KQkq - 3 17"    )
                                    (33 . "r3k2r/ppb2ppp/2b1p3/2P1n3/1PP1N3/P4B2/1B4PP/2KR3R b kq - 4 17"      )
                                    (34 . "r3k2r/ppb2ppp/2b1p3/2P5/1PP1N3/P4n2/1B4PP/2KR3R w kq - 0 18"        )
                                    (35 . "r3k2r/ppb2ppp/2b1p3/2P5/1PP1N3/P4P2/1B5P/2KR3R b kq - 0 18"         )
                                    (36 . "r3k2r/pp3ppp/2b1p3/2P5/1PP1Nb2/P4P2/1B5P/2KR3R w kq - 1 19"         )
                                    (37 . "r3k2r/pp3ppp/2b1p3/2P5/1PP1Nb2/P4P2/1B5P/1K1R3R b kq - 2 19"        )
                                    (38 . "r3k2r/pp4pp/2b1pp2/2P5/1PP1Nb2/P4P2/1B5P/1K1R3R w kq - 0 20"        )
                                    (39 . "r3k2r/pp4pp/2b1pp2/2P5/1PP1Nb2/P4P2/1B5P/1K1R2R1 b kq - 1 20"       )
                                    (40 . "r6r/pp3kpp/2b1pp2/2P5/1PP1Nb2/P4P2/1B5P/1K1R2R1 w - - 2 21"         )
                                    (41 . "r6r/pp3kpp/2bNpp2/2P5/1PP2b2/P4P2/1B5P/1K1R2R1 b - - 3 21"          )
                                    (42 . "r6r/pp3kpp/2bbpp2/2P5/1PP5/P4P2/1B5P/1K1R2R1 w - - 0 22"            )
                                    (43 . "r6r/pp3kpp/2bRpp2/2P5/1PP5/P4P2/1B5P/1K4R1 b - - 0 22"              )
                                    (44 . "r6r/pp3k1p/2bRpp2/2P3p1/1PP5/P4P2/1B5P/1K4R1 w - - 0 23"            )
                                    (45 . "r6r/pp3k1p/2bRpp2/2P3p1/1PP5/P4P2/1B5P/1K3R2 b - - 1 23"            )
                                    (46 . "r6r/1p3k1p/p1bRpp2/2P3p1/1PP5/P4P2/1B5P/1K3R2 w - - 0 24"           )
                                    (47 . "r6r/1p3k1p/p1bRpp2/2P3p1/1PP5/P4P2/1BK4P/5R2 b - - 1 24"            )
                                    (48 . "r2r4/1p3k1p/p1bRpp2/2P3p1/1PP5/P4P2/1BK4P/5R2 w - - 2 25"           )
                                    (49 . "r2r4/1p3k1p/p1bRpp2/2P3p1/1PP5/P4P2/1B1K3P/5R2 b - - 3 25"          )
                                    (50 . "r2r4/1p3k1p/p1bR1p2/2P1p1p1/1PP5/P4P2/1B1K3P/5R2 w - - 0 26"        )
                                    (51 . "r2r4/1p3k1p/p1bR1p2/2P1p1p1/1PP5/P3KP2/1B5P/5R2 b - - 1 26"         )
                                    (52 . "r7/1p3k1p/p1br1p2/2P1p1p1/1PP5/P3KP2/1B5P/5R2 w - - 0 27"           )
                                    (53 . "r7/1p3k1p/p1bP1p2/4p1p1/1PP5/P3KP2/1B5P/5R2 b - - 0 27"             )
                                    (54 . "r7/1p5p/p1bPkp2/4p1p1/1PP5/P3KP2/1B5P/5R2 w - - 1 28"               )
                                    (55 . "r7/1p5p/p1bPkp2/2P1p1p1/1P6/P3KP2/1B5P/5R2 b - - 0 28"              )
                                    (56 . "r7/7p/ppbPkp2/2P1p1p1/1P6/P3KP2/1B5P/5R2 w - - 0 29"                )
                                    (57 . "r7/7p/ppbPkp2/2P1p1p1/1P5P/P3KP2/1B6/5R2 b - - 0 29"                )
                                    (58 . "r7/8/ppbPkp1p/2P1p1p1/1P5P/P3KP2/1B6/5R2 w - - 0 30"                )
                                    (59 . "r7/8/ppbPkp1p/2P1p1P1/1P6/P3KP2/1B6/5R2 b - - 0 30"                 )
                                    (60 . "r7/8/ppbPkp2/2P1p1p1/1P6/P3KP2/1B6/5R2 w - - 0 31"                  )
                                    (61 . "r7/8/pPbPkp2/4p1p1/1P6/P3KP2/1B6/5R2 b - - 0 31"                    )
                                    (62 . "1r6/8/pPbPkp2/4p1p1/1P6/P3KP2/1B6/5R2 w - - 1 32"                   )
                                    (63 . "1r6/8/pPbPkp2/4p1p1/1P6/P3KP2/1B6/3R4 b - - 2 32"                   )
                                    (64 . "8/8/prbPkp2/4p1p1/1P6/P3KP2/1B6/3R4 w - - 0 33"                     )
                                    (65 . "8/8/prbPkp2/4p1p1/1P6/P4P2/1B3K2/3R4 b - - 1 33"                    )
                                    (66 . "8/8/pr1Pkp2/4p1p1/bP6/P4P2/1B3K2/3R4 w - - 2 34"                    )
                                    (67 . "8/8/pr1Pkp2/4p1p1/bP6/P4P2/1B1R1K2/8 b - - 3 34"                    )
                                    (68 . "1r6/8/p2Pkp2/4p1p1/bP6/P4P2/1B1R1K2/8 w - - 4 35"                   )
                                    (69 . "1r6/8/p2Pkp2/4p1p1/bP6/P4PK1/1B1R4/8 b - - 5 35"                    )
                                    (70 . "2r5/8/p2Pkp2/4p1p1/bP6/P4PK1/1B1R4/8 w - - 6 36"                    )
                                    (71 . "2r5/8/p2Pkp2/4p1p1/bP6/P4P2/1B1R1K2/8 b - - 7 36"                   )
                                    (72 . "8/8/p2Pkp2/4p1p1/bPr5/P4P2/1B1R1K2/8 w - - 8 37"                    )
                                    (73 . "8/8/p2Pkp2/4p1p1/bPr5/P4PK1/1B1R4/8 b - - 9 37"                     )
                                    (74 . "2r5/8/p2Pkp2/4p1p1/bP6/P4PK1/1B1R4/8 w - - 10 38"                   )
                                    (75 . "2r5/8/p2Pkp2/4p1p1/bP6/P4P2/1B1R1K2/8 b - - 11 38"                  )
                                    (76 . "7r/8/p2Pkp2/4p1p1/bP6/P4P2/1B1R1K2/8 w - - 12 39"                   )
                                    (77 . "7r/8/p2Pkp2/4p1p1/bP6/P4PK1/1B1R4/8 b - - 13 39"                    )
                                    (78 . "8/8/p2Pkp2/4p1p1/bP6/P4PK1/1B1R4/7r w - - 14 40"                    )
                                    (79 . "8/8/p2Pkp2/4p1p1/bP6/P4P2/1B1R2K1/7r b - - 15 40"                   )
                                    (80 . "8/8/p2Pkp2/4p1p1/bP6/P4P2/1B1R2K1/1r6 w - - 16 41"                  )
                                    (81 . "8/8/p2Pkp2/4p1p1/bP6/P4PK1/1B1R4/1r6 b - - 17 41"                   )
                                    (82 . "8/8/p1bPkp2/4p1p1/1P6/P4PK1/1B1R4/1r6 w - - 18 42"                  )
                                    (83 . "8/8/p1bPkp2/4p1p1/1P6/P4P2/1B1R1K2/1r6 b - - 19 42"                 )
                                    (84 . "8/3k4/p1bP1p2/4p1p1/1P6/P4P2/1B1R1K2/1r6 w - - 20 43"               )
                                    (85 . "8/3k4/p1bP1p2/4p1p1/1P6/P4PK1/1B1R4/1r6 b - - 21 43"                )
                                    (86 . "8/3k4/p1bP1p2/4p1p1/1P6/P4PK1/1B1R4/5r2 w - - 22 44"                )
                                    (87 . "8/3k4/p1bP1p2/4p1p1/1P6/P2R1PK1/1B6/5r2 b - - 23 44"                )
                                    (88 . "8/8/p1bPkp2/4p1p1/1P6/P2R1PK1/1B6/5r2 w - - 24 45"                  )
                                    (89 . "8/8/p1bPkp2/4p1p1/1P4K1/P2R1P2/1B6/5r2 b - - 25 45"                 )
                                    (90 . "8/8/p1bPkp2/4p1p1/1P4K1/P2R1P2/1B6/1r6 w - - 26 46"                 )
                                    (91 . "8/8/p1bPkp2/4p1p1/1P4K1/P4P2/1B1R4/1r6 b - - 27 46"                 )
                                    (92 . "8/8/p1bPkp2/4p1p1/1P4K1/P4P2/1B1R4/6r1 w - - 28 47"                 )
                                    (93 . "8/8/p1bPkp2/4p1p1/1P6/P4P1K/1B1R4/6r1 b - - 29 47"                  )
                                    (94 . "8/8/p1bPkp2/4p1p1/1P6/P4P1K/1B1R4/5r2 w - - 30 48"                  )))

(setq pygn-mode-test-03-game-start-positions '((1 . 1)
                                               (2 . 982)
                                               (3 . 1963)
                                               (4 . 2944)
                                               (5 . 3925)))

(setq pygn-mode-test-01-closest-named-node-at-pos '((  1 . tagpair_delimiter_open)
                                                    (  2 . tagpair_key)
                                                    (  3 . tagpair_key)
                                                    (  4 . tagpair_key)
                                                    (  5 . tagpair_key)
                                                    (  6 . tagpair_key)
                                                    (  7 . tagpair)
                                                    (  8 . double_quote)
                                                    (  9 . tagpair_value_contents)
                                                    ( 10 . double_quote)
                                                    ( 11 . tagpair_delimiter_close)
                                                    ( 12 . header)
                                                    ( 13 . tagpair_delimiter_open)
                                                    ( 14 . tagpair_key)
                                                    ( 15 . tagpair_key)
                                                    ( 16 . tagpair_key)
                                                    ( 17 . tagpair_key)
                                                    ( 18 . tagpair)
                                                    ( 19 . double_quote)
                                                    ( 20 . tagpair_value_contents)
                                                    ( 21 . double_quote)
                                                    ( 22 . tagpair_delimiter_close)
                                                    ( 23 . header)
                                                    ( 24 . tagpair_delimiter_open)
                                                    ( 25 . tagpair_key)
                                                    ( 26 . tagpair_key)
                                                    ( 27 . tagpair_key)
                                                    ( 28 . tagpair_key)
                                                    ( 29 . tagpair)
                                                    ( 30 . double_quote)
                                                    ( 31 . tagpair_value_contents)
                                                    ( 32 . tagpair_value_contents)
                                                    ( 33 . tagpair_value_contents)
                                                    ( 34 . tagpair_value_contents)
                                                    ( 35 . tagpair_value_contents)
                                                    ( 36 . tagpair_value_contents)
                                                    ( 37 . tagpair_value_contents)
                                                    ( 38 . tagpair_value_contents)
                                                    ( 39 . tagpair_value_contents)
                                                    ( 40 . tagpair_value_contents)
                                                    ( 41 . double_quote)
                                                    ( 42 . tagpair_delimiter_close)
                                                    ( 43 . header)
                                                    ( 44 . tagpair_delimiter_open)
                                                    ( 45 . tagpair_key)
                                                    ( 46 . tagpair_key)
                                                    ( 47 . tagpair_key)
                                                    ( 48 . tagpair_key)
                                                    ( 49 . tagpair_key)
                                                    ( 50 . tagpair)
                                                    ( 51 . double_quote)
                                                    ( 52 . tagpair_value_contents)
                                                    ( 53 . double_quote)
                                                    ( 54 . tagpair_delimiter_close)
                                                    ( 55 . header)
                                                    ( 56 . tagpair_delimiter_open)
                                                    ( 57 . tagpair_key)
                                                    ( 58 . tagpair_key)
                                                    ( 59 . tagpair_key)
                                                    ( 60 . tagpair_key)
                                                    ( 61 . tagpair_key)
                                                    ( 62 . tagpair)
                                                    ( 63 . double_quote)
                                                    ( 64 . tagpair_value_contents)
                                                    ( 65 . double_quote)
                                                    ( 66 . tagpair_delimiter_close)
                                                    ( 67 . header)
                                                    ( 68 . tagpair_delimiter_open)
                                                    ( 69 . tagpair_key)
                                                    ( 70 . tagpair_key)
                                                    ( 71 . tagpair_key)
                                                    ( 72 . tagpair_key)
                                                    ( 73 . tagpair_key)
                                                    ( 74 . tagpair)
                                                    ( 75 . double_quote)
                                                    ( 76 . tagpair_value_contents)
                                                    ( 77 . double_quote)
                                                    ( 78 . tagpair_delimiter_close)
                                                    ( 79 . header)
                                                    ( 80 . tagpair_delimiter_open)
                                                    ( 81 . tagpair_key)
                                                    ( 82 . tagpair_key)
                                                    ( 83 . tagpair_key)
                                                    ( 84 . tagpair_key)
                                                    ( 85 . tagpair_key)
                                                    ( 86 . tagpair_key)
                                                    ( 87 . tagpair)
                                                    ( 88 . double_quote)
                                                    ( 89 . tagpair_value_contents)
                                                    ( 90 . double_quote)
                                                    ( 91 . tagpair_delimiter_close)
                                                    ( 92 . header)
                                                    ( 93 . tagpair_delimiter_open)
                                                    ( 94 . tagpair_key)
                                                    ( 95 . tagpair_key)
                                                    ( 96 . tagpair_key)
                                                    ( 97 . tagpair_key)
                                                    ( 98 . tagpair_key)
                                                    ( 99 . tagpair)
                                                    (100 . double_quote)
                                                    (101 . tagpair_value_contents)
                                                    (102 . double_quote)
                                                    (103 . tagpair_delimiter_close)
                                                    (104 . header)
                                                    (105 . tagpair_delimiter_open)
                                                    (106 . tagpair_key)
                                                    (107 . tagpair_key)
                                                    (108 . tagpair_key)
                                                    (109 . tagpair)
                                                    (110 . double_quote)
                                                    (111 . tagpair_value_contents)
                                                    (112 . tagpair_value_contents)
                                                    (113 . tagpair_value_contents)
                                                    (114 . tagpair_value_contents)
                                                    (115 . tagpair_value_contents)
                                                    (116 . tagpair_value_contents)
                                                    (117 . tagpair_value_contents)
                                                    (118 . tagpair_value_contents)
                                                    (119 . tagpair_value_contents)
                                                    (120 . tagpair_value_contents)
                                                    (121 . tagpair_value_contents)
                                                    (122 . tagpair_value_contents)
                                                    (123 . tagpair_value_contents)
                                                    (124 . tagpair_value_contents)
                                                    (125 . tagpair_value_contents)
                                                    (126 . tagpair_value_contents)
                                                    (127 . tagpair_value_contents)
                                                    (128 . tagpair_value_contents)
                                                    (129 . tagpair_value_contents)
                                                    (130 . tagpair_value_contents)
                                                    (131 . tagpair_value_contents)
                                                    (132 . tagpair_value_contents)
                                                    (133 . tagpair_value_contents)
                                                    (134 . tagpair_value_contents)
                                                    (135 . tagpair_value_contents)
                                                    (136 . tagpair_value_contents)
                                                    (137 . tagpair_value_contents)
                                                    (138 . tagpair_value_contents)
                                                    (139 . tagpair_value_contents)
                                                    (140 . tagpair_value_contents)
                                                    (141 . tagpair_value_contents)
                                                    (142 . tagpair_value_contents)
                                                    (143 . tagpair_value_contents)
                                                    (144 . tagpair_value_contents)
                                                    (145 . tagpair_value_contents)
                                                    (146 . tagpair_value_contents)
                                                    (147 . tagpair_value_contents)
                                                    (148 . tagpair_value_contents)
                                                    (149 . tagpair_value_contents)
                                                    (150 . tagpair_value_contents)
                                                    (151 . tagpair_value_contents)
                                                    (152 . tagpair_value_contents)
                                                    (153 . tagpair_value_contents)
                                                    (154 . tagpair_value_contents)
                                                    (155 . tagpair_value_contents)
                                                    (156 . tagpair_value_contents)
                                                    (157 . tagpair_value_contents)
                                                    (158 . tagpair_value_contents)
                                                    (159 . tagpair_value_contents)
                                                    (160 . tagpair_value_contents)
                                                    (161 . tagpair_value_contents)
                                                    (162 . tagpair_value_contents)
                                                    (163 . tagpair_value_contents)
                                                    (164 . tagpair_value_contents)
                                                    (165 . tagpair_value_contents)
                                                    (166 . tagpair_value_contents)
                                                    (167 . tagpair_value_contents)
                                                    (168 . tagpair_value_contents)
                                                    (169 . tagpair_value_contents)
                                                    (170 . tagpair_value_contents)
                                                    (171 . tagpair_value_contents)
                                                    (172 . tagpair_value_contents)
                                                    (173 . double_quote)
                                                    (174 . tagpair_delimiter_close)
                                                    (175 . game)
                                                    (176 . game)
                                                    (177 . move_number)
                                                    (178 . move_number)
                                                    (179 . move_number)
                                                    (180 . movetext)
                                                    (181 . san_move)
                                                    (182 . san_move)
                                                    (183 . san_move)
                                                    (184 . check_or_mate_condition)
                                                    (185 . movetext)
                                                    (186 . san_move)
                                                    (187 . san_move)
                                                    (188 . san_move)
                                                    (189 . movetext)
                                                    (190 . variation_delimiter_open)
                                                    (191 . inline_comment_delimiter_open)
                                                    (192 . inline_comment_text)
                                                    (193 . inline_comment_text)
                                                    (194 . inline_comment_text)
                                                    (195 . inline_comment_text)
                                                    (196 . inline_comment_text)
                                                    (197 . inline_comment_delimiter_close)
                                                    (198 . variation_movetext)
                                                    (199 . move_number)
                                                    (200 . move_number)
                                                    (201 . move_number)
                                                    (202 . move_number)
                                                    (203 . move_number)
                                                    (204 . variation_movetext)
                                                    (205 . san_move)
                                                    (206 . san_move)
                                                    (207 . san_move)
                                                    (208 . variation_movetext)
                                                    (209 . move_number)
                                                    (210 . move_number)
                                                    (211 . move_number)
                                                    (212 . variation_movetext)
                                                    (213 . san_move)
                                                    (214 . san_move)
                                                    (215 . san_move)
                                                    (216 . san_move)
                                                    (217 . variation_movetext)
                                                    (218 . san_move)
                                                    (219 . san_move)
                                                    (220 . san_move)
                                                    (221 . variation_movetext)
                                                    (222 . move_number)
                                                    (223 . move_number)
                                                    (224 . move_number)
                                                    (225 . variation_movetext)
                                                    (226 . san_move)
                                                    (227 . san_move)
                                                    (228 . san_move)
                                                    (229 . san_move)
                                                    (230 . variation_movetext)
                                                    (231 . san_move)
                                                    (232 . san_move)
                                                    (233 . san_move)
                                                    (234 . san_move)
                                                    (235 . variation_movetext)
                                                    (236 . move_number)
                                                    (237 . move_number)
                                                    (238 . move_number)
                                                    (239 . variation_movetext)
                                                    (240 . san_move)
                                                    (241 . san_move)
                                                    (242 . san_move)
                                                    (243 . san_move)
                                                    (244 . variation_movetext)
                                                    (245 . san_move)
                                                    (246 . san_move)
                                                    (247 . san_move)
                                                    (248 . variation_movetext)
                                                    (249 . move_number)
                                                    (250 . move_number)
                                                    (251 . move_number)
                                                    (252 . variation_movetext)
                                                    (253 . san_move)
                                                    (254 . san_move)
                                                    (255 . san_move)
                                                    (256 . variation_movetext)
                                                    (257 . san_move)
                                                    (258 . san_move)
                                                    (259 . san_move)
                                                    (260 . variation_movetext)
                                                    (261 . move_number)
                                                    (262 . move_number)
                                                    (263 . move_number)
                                                    (264 . variation_movetext)
                                                    (265 . san_move)
                                                    (266 . san_move)
                                                    (267 . san_move)
                                                    (268 . variation_movetext)
                                                    (269 . annotation)
                                                    (270 . annotation)
                                                    (271 . variation_delimiter_close)
                                                    (272 . movetext)
                                                    (273 . move_number)
                                                    (274 . move_number)
                                                    (275 . move_number)
                                                    (276 . movetext)
                                                    (277 . san_move)
                                                    (278 . san_move)
                                                    (279 . san_move)
                                                    (280 . san_move)
                                                    (281 . movetext)
                                                    (282 . san_move)
                                                    (283 . san_move)
                                                    (284 . san_move)
                                                    (285 . san_move)
                                                    (286 . movetext)
                                                    (287 . variation_delimiter_open)
                                                    (288 . inline_comment_delimiter_open)
                                                    (289 . inline_comment_text)
                                                    (290 . inline_comment_text)
                                                    (291 . inline_comment_text)
                                                    (292 . inline_comment_text)
                                                    (293 . inline_comment_text)
                                                    (294 . inline_comment_delimiter_close)
                                                    (295 . variation_movetext)
                                                    (296 . move_number)
                                                    (297 . move_number)
                                                    (298 . move_number)
                                                    (299 . move_number)
                                                    (300 . move_number)
                                                    (301 . variation_movetext)
                                                    (302 . san_move)
                                                    (303 . san_move)
                                                    (304 . san_move)
                                                    (305 . variation_movetext)
                                                    (306 . move_number)
                                                    (307 . move_number)
                                                    (308 . move_number)
                                                    (309 . variation_movetext)
                                                    (310 . san_move)
                                                    (311 . san_move)
                                                    (312 . san_move)
                                                    (313 . san_move)
                                                    (314 . variation_movetext)
                                                    (315 . san_move)
                                                    (316 . san_move)
                                                    (317 . san_move)
                                                    (318 . san_move)
                                                    (319 . variation_movetext)
                                                    (320 . move_number)
                                                    (321 . move_number)
                                                    (322 . move_number)
                                                    (323 . variation_movetext)
                                                    (324 . san_move)
                                                    (325 . san_move)
                                                    (326 . san_move)
                                                    (327 . san_move)
                                                    (328 . variation_movetext)
                                                    (329 . san_move)
                                                    (330 . san_move)
                                                    (331 . san_move)
                                                    (332 . variation_movetext)
                                                    (333 . move_number)
                                                    (334 . move_number)
                                                    (335 . move_number)
                                                    (336 . variation_movetext)
                                                    (337 . san_move)
                                                    (338 . san_move)
                                                    (339 . san_move)
                                                    (340 . san_move)
                                                    (341 . variation_movetext)
                                                    (342 . san_move)
                                                    (343 . san_move)
                                                    (344 . variation_movetext)
                                                    (345 . move_number)
                                                    (346 . move_number)
                                                    (347 . move_number)
                                                    (348 . variation_movetext)
                                                    (349 . san_move)
                                                    (350 . san_move)
                                                    (351 . san_move)
                                                    (352 . san_move)
                                                    (353 . variation_movetext)
                                                    (354 . san_move)
                                                    (355 . san_move)
                                                    (356 . san_move)
                                                    (357 . san_move)
                                                    (358 . variation_movetext)
                                                    (359 . move_number)
                                                    (360 . move_number)
                                                    (361 . move_number)
                                                    (362 . variation_movetext)
                                                    (363 . san_move)
                                                    (364 . san_move)
                                                    (365 . san_move)
                                                    (366 . san_move)
                                                    (367 . variation_movetext)
                                                    (368 . annotation)
                                                    (369 . annotation)
                                                    (370 . variation_delimiter_close)
                                                    (371 . movetext)
                                                    (372 . variation_delimiter_open)
                                                    (373 . inline_comment_delimiter_open)
                                                    (374 . inline_comment_text)
                                                    (375 . inline_comment_text)
                                                    (376 . inline_comment_text)
                                                    (377 . inline_comment_text)
                                                    (378 . inline_comment_text)
                                                    (379 . inline_comment_delimiter_close)
                                                    (380 . variation_movetext)
                                                    (381 . move_number)
                                                    (382 . move_number)
                                                    (383 . move_number)
                                                    (384 . move_number)
                                                    (385 . move_number)
                                                    (386 . variation_movetext)
                                                    (387 . san_move)
                                                    (388 . san_move)
                                                    (389 . san_move)
                                                    (390 . variation_movetext)
                                                    (391 . move_number)
                                                    (392 . move_number)
                                                    (393 . move_number)
                                                    (394 . variation_movetext)
                                                    (395 . san_move)
                                                    (396 . san_move)
                                                    (397 . san_move)
                                                    (398 . check_or_mate_condition)
                                                    (399 . variation_movetext)
                                                    (400 . san_move)
                                                    (401 . san_move)
                                                    (402 . san_move)
                                                    (403 . variation_movetext)
                                                    (404 . move_number)
                                                    (405 . move_number)
                                                    (406 . move_number)
                                                    (407 . variation_movetext)
                                                    (408 . san_move)
                                                    (409 . san_move)
                                                    (410 . san_move)
                                                    (411 . variation_movetext)
                                                    (412 . san_move)
                                                    (413 . san_move)
                                                    (414 . variation_movetext)
                                                    (415 . move_number)
                                                    (416 . move_number)
                                                    (417 . move_number)
                                                    (418 . variation_movetext)
                                                    (419 . san_move)
                                                    (420 . san_move)
                                                    (421 . san_move)
                                                    (422 . san_move)
                                                    (423 . variation_movetext)
                                                    (424 . san_move)
                                                    (425 . san_move)
                                                    (426 . san_move)
                                                    (427 . variation_movetext)
                                                    (428 . move_number)
                                                    (429 . move_number)
                                                    (430 . move_number)
                                                    (431 . variation_movetext)
                                                    (432 . san_move)
                                                    (433 . san_move)
                                                    (434 . san_move)
                                                    (435 . variation_movetext)
                                                    (436 . san_move)
                                                    (437 . san_move)
                                                    (438 . variation_movetext)
                                                    (439 . move_number)
                                                    (440 . move_number)
                                                    (441 . move_number)
                                                    (442 . variation_movetext)
                                                    (443 . san_move)
                                                    (444 . san_move)
                                                    (445 . san_move)
                                                    (446 . variation_movetext)
                                                    (447 . annotation)
                                                    (448 . annotation)
                                                    (449 . variation_delimiter_close)
                                                    (450 . movetext)
                                                    (451 . move_number)
                                                    (452 . move_number)
                                                    (453 . move_number)
                                                    (454 . movetext)
                                                    (455 . san_move)
                                                    (456 . san_move)
                                                    (457 . san_move)
                                                    (458 . movetext)
                                                    (459 . san_move)
                                                    (460 . san_move)
                                                    (461 . san_move)
                                                    (462 . movetext)
                                                    (463 . variation_delimiter_open)
                                                    (464 . inline_comment_delimiter_open)
                                                    (465 . inline_comment_text)
                                                    (466 . inline_comment_text)
                                                    (467 . inline_comment_text)
                                                    (468 . inline_comment_text)
                                                    (469 . inline_comment_delimiter_close)
                                                    (470 . variation_movetext)
                                                    (471 . move_number)
                                                    (472 . move_number)
                                                    (473 . move_number)
                                                    (474 . move_number)
                                                    (475 . move_number)
                                                    (476 . variation_movetext)
                                                    (477 . san_move)
                                                    (478 . san_move)
                                                    (479 . san_move)
                                                    (480 . variation_movetext)
                                                    (481 . move_number)
                                                    (482 . move_number)
                                                    (483 . move_number)
                                                    (484 . variation_movetext)
                                                    (485 . san_move)
                                                    (486 . san_move)
                                                    (487 . san_move)
                                                    (488 . san_move)
                                                    (489 . check_or_mate_condition)
                                                    (490 . variation_movetext)
                                                    (491 . san_move)
                                                    (492 . san_move)
                                                    (493 . san_move)
                                                    (494 . variation_movetext)
                                                    (495 . move_number)
                                                    (496 . move_number)
                                                    (497 . move_number)
                                                    (498 . variation_movetext)
                                                    (499 . san_move)
                                                    (500 . san_move)
                                                    (501 . san_move)
                                                    (502 . variation_movetext)
                                                    (503 . san_move)
                                                    (504 . san_move)
                                                    (505 . san_move)
                                                    (506 . san_move)
                                                    (507 . variation_movetext)
                                                    (508 . move_number)
                                                    (509 . move_number)
                                                    (510 . move_number)
                                                    (511 . variation_movetext)
                                                    (512 . san_move)
                                                    (513 . san_move)
                                                    (514 . san_move)
                                                    (515 . san_move)
                                                    (516 . check_or_mate_condition)
                                                    (517 . variation_movetext)
                                                    (518 . san_move)
                                                    (519 . san_move)
                                                    (520 . san_move)
                                                    (521 . variation_movetext)
                                                    (522 . move_number)
                                                    (523 . move_number)
                                                    (524 . move_number)
                                                    (525 . variation_movetext)
                                                    (526 . san_move)
                                                    (527 . san_move)
                                                    (528 . san_move)
                                                    (529 . san_move)
                                                    (530 . variation_movetext)
                                                    (531 . san_move)
                                                    (532 . san_move)
                                                    (533 . san_move)
                                                    (534 . san_move)
                                                    (535 . variation_movetext)
                                                    (536 . move_number)
                                                    (537 . move_number)
                                                    (538 . move_number)
                                                    (539 . variation_movetext)
                                                    (540 . san_move)
                                                    (541 . san_move)
                                                    (542 . san_move)
                                                    (543 . san_move)
                                                    (544 . check_or_mate_condition)
                                                    (545 . variation_movetext)
                                                    (546 . annotation)
                                                    (547 . variation_delimiter_close)
                                                    (548 . movetext)
                                                    (549 . variation_delimiter_open)
                                                    (550 . inline_comment_delimiter_open)
                                                    (551 . inline_comment_text)
                                                    (552 . inline_comment_text)
                                                    (553 . inline_comment_text)
                                                    (554 . inline_comment_text)
                                                    (555 . inline_comment_delimiter_close)
                                                    (556 . variation_movetext)
                                                    (557 . move_number)
                                                    (558 . move_number)
                                                    (559 . move_number)
                                                    (560 . move_number)
                                                    (561 . move_number)
                                                    (562 . variation_movetext)
                                                    (563 . san_move)
                                                    (564 . san_move)
                                                    (565 . san_move)
                                                    (566 . variation_movetext)
                                                    (567 . move_number)
                                                    (568 . move_number)
                                                    (569 . move_number)
                                                    (570 . variation_movetext)
                                                    (571 . san_move)
                                                    (572 . san_move)
                                                    (573 . san_move)
                                                    (574 . variation_movetext)
                                                    (575 . san_move)
                                                    (576 . san_move)
                                                    (577 . san_move)
                                                    (578 . san_move)
                                                    (579 . variation_movetext)
                                                    (580 . move_number)
                                                    (581 . move_number)
                                                    (582 . move_number)
                                                    (583 . variation_movetext)
                                                    (584 . san_move)
                                                    (585 . san_move)
                                                    (586 . san_move)
                                                    (587 . variation_movetext)
                                                    (588 . san_move)
                                                    (589 . san_move)
                                                    (590 . san_move)
                                                    (591 . check_or_mate_condition)
                                                    (592 . variation_movetext)
                                                    (593 . move_number)
                                                    (594 . move_number)
                                                    (595 . move_number)
                                                    (596 . variation_movetext)
                                                    (597 . san_move)
                                                    (598 . san_move)
                                                    (599 . san_move)
                                                    (600 . variation_movetext)
                                                    (601 . san_move)
                                                    (602 . san_move)
                                                    (603 . san_move)
                                                    (604 . variation_movetext)
                                                    (605 . annotation)
                                                    (606 . variation_delimiter_close)
                                                    (607 . movetext)
                                                    (608 . move_number)
                                                    (609 . move_number)
                                                    (610 . move_number)
                                                    (611 . movetext)
                                                    (612 . san_move)
                                                    (613 . san_move)
                                                    (614 . san_move)
                                                    (615 . movetext)
                                                    (616 . san_move)
                                                    (617 . san_move)
                                                    (618 . san_move)
                                                    (619 . san_move)
                                                    (620 . movetext)
                                                    (621 . variation_delimiter_open)
                                                    (622 . inline_comment_delimiter_open)
                                                    (623 . inline_comment_text)
                                                    (624 . inline_comment_text)
                                                    (625 . inline_comment_text)
                                                    (626 . inline_comment_text)
                                                    (627 . inline_comment_delimiter_close)
                                                    (628 . variation_movetext)
                                                    (629 . move_number)
                                                    (630 . move_number)
                                                    (631 . move_number)
                                                    (632 . move_number)
                                                    (633 . move_number)
                                                    (634 . variation_movetext)
                                                    (635 . san_move)
                                                    (636 . san_move)
                                                    (637 . san_move)
                                                    (638 . variation_movetext)
                                                    (639 . move_number)
                                                    (640 . move_number)
                                                    (641 . move_number)
                                                    (642 . variation_movetext)
                                                    (643 . san_move)
                                                    (644 . san_move)
                                                    (645 . san_move)
                                                    (646 . check_or_mate_condition)
                                                    (647 . variation_movetext)
                                                    (648 . san_move)
                                                    (649 . san_move)
                                                    (650 . san_move)
                                                    (651 . variation_movetext)
                                                    (652 . move_number)
                                                    (653 . move_number)
                                                    (654 . move_number)
                                                    (655 . variation_movetext)
                                                    (656 . san_move)
                                                    (657 . san_move)
                                                    (658 . san_move)
                                                    (659 . check_or_mate_condition)
                                                    (660 . variation_movetext)
                                                    (661 . san_move)
                                                    (662 . san_move)
                                                    (663 . san_move)
                                                    (664 . variation_movetext)
                                                    (665 . move_number)
                                                    (666 . move_number)
                                                    (667 . move_number)
                                                    (668 . variation_movetext)
                                                    (669 . san_move)
                                                    (670 . san_move)
                                                    (671 . san_move)
                                                    (672 . san_move)
                                                    (673 . check_or_mate_condition)
                                                    (674 . variation_movetext)
                                                    (675 . san_move)
                                                    (676 . san_move)
                                                    (677 . san_move)
                                                    (678 . san_move)
                                                    (679 . variation_movetext)
                                                    (680 . move_number)
                                                    (681 . move_number)
                                                    (682 . move_number)
                                                    (683 . variation_movetext)
                                                    (684 . san_move)
                                                    (685 . san_move)
                                                    (686 . san_move)
                                                    (687 . san_move)
                                                    (688 . check_or_mate_condition)
                                                    (689 . variation_movetext)
                                                    (690 . san_move)
                                                    (691 . san_move)
                                                    (692 . san_move)
                                                    (693 . variation_movetext)
                                                    (694 . move_number)
                                                    (695 . move_number)
                                                    (696 . move_number)
                                                    (697 . variation_movetext)
                                                    (698 . san_move)
                                                    (699 . san_move)
                                                    (700 . san_move)
                                                    (701 . san_move)
                                                    (702 . variation_movetext)
                                                    (703 . annotation)
                                                    (704 . variation_delimiter_close)
                                                    (705 . movetext)
                                                    (706 . variation_delimiter_open)
                                                    (707 . inline_comment_delimiter_open)
                                                    (708 . inline_comment_text)
                                                    (709 . inline_comment_text)
                                                    (710 . inline_comment_text)
                                                    (711 . inline_comment_text)
                                                    (712 . inline_comment_delimiter_close)
                                                    (713 . variation_movetext)
                                                    (714 . move_number)
                                                    (715 . move_number)
                                                    (716 . move_number)
                                                    (717 . move_number)
                                                    (718 . move_number)
                                                    (719 . variation_movetext)
                                                    (720 . san_move)
                                                    (721 . san_move)
                                                    (722 . san_move)
                                                    (723 . variation_movetext)
                                                    (724 . move_number)
                                                    (725 . move_number)
                                                    (726 . move_number)
                                                    (727 . variation_movetext)
                                                    (728 . san_move)
                                                    (729 . san_move)
                                                    (730 . san_move)
                                                    (731 . check_or_mate_condition)
                                                    (732 . variation_movetext)
                                                    (733 . san_move)
                                                    (734 . san_move)
                                                    (735 . san_move)
                                                    (736 . variation_movetext)
                                                    (737 . move_number)
                                                    (738 . move_number)
                                                    (739 . move_number)
                                                    (740 . variation_movetext)
                                                    (741 . san_move)
                                                    (742 . san_move)
                                                    (743 . san_move)
                                                    (744 . san_move)
                                                    (745 . check_or_mate_condition)
                                                    (746 . variation_movetext)
                                                    (747 . san_move)
                                                    (748 . san_move)
                                                    (749 . san_move)
                                                    (750 . san_move)
                                                    (751 . variation_movetext)
                                                    (752 . move_number)
                                                    (753 . move_number)
                                                    (754 . move_number)
                                                    (755 . variation_movetext)
                                                    (756 . san_move)
                                                    (757 . san_move)
                                                    (758 . san_move)
                                                    (759 . san_move)
                                                    (760 . check_or_mate_condition)
                                                    (761 . variation_movetext)
                                                    (762 . san_move)
                                                    (763 . san_move)
                                                    (764 . san_move)
                                                    (765 . variation_movetext)
                                                    (766 . move_number)
                                                    (767 . move_number)
                                                    (768 . move_number)
                                                    (769 . variation_movetext)
                                                    (770 . san_move)
                                                    (771 . san_move)
                                                    (772 . san_move)
                                                    (773 . san_move)
                                                    (774 . variation_movetext)
                                                    (775 . san_move)
                                                    (776 . san_move)
                                                    (777 . san_move)
                                                    (778 . variation_movetext)
                                                    (779 . move_number)
                                                    (780 . move_number)
                                                    (781 . move_number)
                                                    (782 . variation_movetext)
                                                    (783 . san_move)
                                                    (784 . san_move)
                                                    (785 . san_move)
                                                    (786 . check_or_mate_condition)
                                                    (787 . variation_movetext)
                                                    (788 . annotation)
                                                    (789 . variation_delimiter_close)
                                                    (790 . movetext)
                                                    (791 . move_number)
                                                    (792 . move_number)
                                                    (793 . move_number)
                                                    (794 . movetext)
                                                    (795 . san_move)
                                                    (796 . san_move)
                                                    (797 . san_move)
                                                    (798 . san_move)
                                                    (799 . movetext)
                                                    (800 . san_move)
                                                    (801 . san_move)
                                                    (802 . movetext)
                                                    (803 . variation_delimiter_open)
                                                    (804 . inline_comment_delimiter_open)
                                                    (805 . inline_comment_text)
                                                    (806 . inline_comment_text)
                                                    (807 . inline_comment_text)
                                                    (808 . inline_comment_text)
                                                    (809 . inline_comment_delimiter_close)
                                                    (810 . variation_movetext)
                                                    (811 . move_number)
                                                    (812 . move_number)
                                                    (813 . move_number)
                                                    (814 . move_number)
                                                    (815 . move_number)
                                                    (816 . variation_movetext)
                                                    (817 . san_move)
                                                    (818 . san_move)
                                                    (819 . san_move)
                                                    (820 . variation_movetext)
                                                    (821 . move_number)
                                                    (822 . move_number)
                                                    (823 . move_number)
                                                    (824 . variation_movetext)
                                                    (825 . san_move)
                                                    (826 . san_move)
                                                    (827 . san_move)
                                                    (828 . san_move)
                                                    (829 . san_move)
                                                    (830 . variation_movetext)
                                                    (831 . san_move)
                                                    (832 . san_move)
                                                    (833 . san_move)
                                                    (834 . variation_movetext)
                                                    (835 . move_number)
                                                    (836 . move_number)
                                                    (837 . move_number)
                                                    (838 . variation_movetext)
                                                    (839 . san_move)
                                                    (840 . san_move)
                                                    (841 . san_move)
                                                    (842 . san_move)
                                                    (843 . check_or_mate_condition)
                                                    (844 . variation_movetext)
                                                    (845 . san_move)
                                                    (846 . san_move)
                                                    (847 . san_move)
                                                    (848 . variation_movetext)
                                                    (849 . move_number)
                                                    (850 . move_number)
                                                    (851 . move_number)
                                                    (852 . variation_movetext)
                                                    (853 . san_move)
                                                    (854 . san_move)
                                                    (855 . san_move)
                                                    (856 . san_move)
                                                    (857 . check_or_mate_condition)
                                                    (858 . variation_movetext)
                                                    (859 . san_move)
                                                    (860 . san_move)
                                                    (861 . san_move)
                                                    (862 . variation_movetext)
                                                    (863 . move_number)
                                                    (864 . move_number)
                                                    (865 . move_number)
                                                    (866 . variation_movetext)
                                                    (867 . san_move)
                                                    (868 . san_move)
                                                    (869 . san_move)
                                                    (870 . check_or_mate_condition)
                                                    (871 . variation_movetext)
                                                    (872 . san_move)
                                                    (873 . san_move)
                                                    (874 . san_move)
                                                    (875 . variation_movetext)
                                                    (876 . move_number)
                                                    (877 . move_number)
                                                    (878 . move_number)
                                                    (879 . variation_movetext)
                                                    (880 . san_move)
                                                    (881 . san_move)
                                                    (882 . san_move)
                                                    (883 . san_move)
                                                    (884 . check_or_mate_condition)
                                                    (885 . variation_movetext)
                                                    (886 . annotation)
                                                    (887 . variation_delimiter_close)
                                                    (888 . movetext)
                                                    (889 . variation_delimiter_open)
                                                    (890 . inline_comment_delimiter_open)
                                                    (891 . inline_comment_text)
                                                    (892 . inline_comment_text)
                                                    (893 . inline_comment_text)
                                                    (894 . inline_comment_text)
                                                    (895 . inline_comment_delimiter_close)
                                                    (896 . variation_movetext)
                                                    (897 . move_number)
                                                    (898 . move_number)
                                                    (899 . move_number)
                                                    (900 . move_number)
                                                    (901 . move_number)
                                                    (902 . variation_movetext)
                                                    (903 . san_move)
                                                    (904 . san_move)
                                                    (905 . variation_movetext)
                                                    (906 . move_number)
                                                    (907 . move_number)
                                                    (908 . move_number)
                                                    (909 . variation_movetext)
                                                    (910 . san_move)
                                                    (911 . san_move)
                                                    (912 . san_move)
                                                    (913 . san_move)
                                                    (914 . san_move)
                                                    (915 . check_or_mate_condition)
                                                    (916 . variation_movetext)
                                                    (917 . san_move)
                                                    (918 . san_move)
                                                    (919 . san_move)
                                                    (920 . variation_movetext)
                                                    (921 . move_number)
                                                    (922 . move_number)
                                                    (923 . move_number)
                                                    (924 . variation_movetext)
                                                    (925 . san_move)
                                                    (926 . san_move)
                                                    (927 . san_move)
                                                    (928 . san_move)
                                                    (929 . check_or_mate_condition)
                                                    (930 . variation_movetext)
                                                    (931 . san_move)
                                                    (932 . san_move)
                                                    (933 . san_move)
                                                    (934 . variation_movetext)
                                                    (935 . move_number)
                                                    (936 . move_number)
                                                    (937 . move_number)
                                                    (938 . variation_movetext)
                                                    (939 . san_move)
                                                    (940 . san_move)
                                                    (941 . san_move)
                                                    (942 . san_move)
                                                    (943 . check_or_mate_condition)
                                                    (944 . variation_movetext)
                                                    (945 . san_move)
                                                    (946 . san_move)
                                                    (947 . san_move)
                                                    (948 . variation_movetext)
                                                    (949 . move_number)
                                                    (950 . move_number)
                                                    (951 . move_number)
                                                    (952 . variation_movetext)
                                                    (953 . san_move)
                                                    (954 . san_move)
                                                    (955 . san_move)
                                                    (956 . check_or_mate_condition)
                                                    (957 . variation_movetext)
                                                    (958 . san_move)
                                                    (959 . san_move)
                                                    (960 . san_move)
                                                    (961 . variation_movetext)
                                                    (962 . annotation)
                                                    (963 . variation_delimiter_close)
                                                    ;; On this one position we might disagree with tree-sitter and call the whitespace
                                                    ;; before the result code "movetext".  It depends on how you think about it. At least
                                                    ;; pygn-mode-inside-separator-p returns nil.
                                                    (964 . game)
                                                    (965 . result_code)
                                                    (966 . series_of_games)
                                                    (967 . series_of_games)))

 (setq pygn-mode-test-recursive-closest-named-node-at-pos '((  1 . tagpair_delimiter_open)
                                                            (  2 . tagpair_key)
                                                            (  3 . tagpair_key)
                                                            (  4 . tagpair_key)
                                                            (  5 . tagpair_key)
                                                            (  6 . tagpair_key)
                                                            (  7 . tagpair)
                                                            (  8 . double_quote)
                                                            (  9 . tagpair_value_contents)
                                                            ( 10 . double_quote)
                                                            ( 11 . tagpair_delimiter_close)
                                                            ( 12 . header)
                                                            ( 13 . tagpair_delimiter_open)
                                                            ( 14 . tagpair_key)
                                                            ( 15 . tagpair_key)
                                                            ( 16 . tagpair_key)
                                                            ( 17 . tagpair_key)
                                                            ( 18 . tagpair)
                                                            ( 19 . double_quote)
                                                            ( 20 . tagpair_value_contents)
                                                            ( 21 . double_quote)
                                                            ( 22 . tagpair_delimiter_close)
                                                            ( 23 . header)
                                                            ( 24 . tagpair_delimiter_open)
                                                            ( 25 . tagpair_key)
                                                            ( 26 . tagpair_key)
                                                            ( 27 . tagpair_key)
                                                            ( 28 . tagpair_key)
                                                            ( 29 . tagpair)
                                                            ( 30 . double_quote)
                                                            ( 31 . tagpair_value_contents)
                                                            ( 32 . tagpair_value_contents)
                                                            ( 33 . tagpair_value_contents)
                                                            ( 34 . tagpair_value_contents)
                                                            ( 35 . tagpair_value_contents)
                                                            ( 36 . tagpair_value_contents)
                                                            ( 37 . tagpair_value_contents)
                                                            ( 38 . tagpair_value_contents)
                                                            ( 39 . tagpair_value_contents)
                                                            ( 40 . tagpair_value_contents)
                                                            ( 41 . double_quote)
                                                            ( 42 . tagpair_delimiter_close)
                                                            ( 43 . header)
                                                            ( 44 . tagpair_delimiter_open)
                                                            ( 45 . tagpair_key)
                                                            ( 46 . tagpair_key)
                                                            ( 47 . tagpair_key)
                                                            ( 48 . tagpair_key)
                                                            ( 49 . tagpair_key)
                                                            ( 50 . tagpair)
                                                            ( 51 . double_quote)
                                                            ( 52 . tagpair_value_contents)
                                                            ( 53 . double_quote)
                                                            ( 54 . tagpair_delimiter_close)
                                                            ( 55 . header)
                                                            ( 56 . tagpair_delimiter_open)
                                                            ( 57 . tagpair_key)
                                                            ( 58 . tagpair_key)
                                                            ( 59 . tagpair_key)
                                                            ( 60 . tagpair_key)
                                                            ( 61 . tagpair_key)
                                                            ( 62 . tagpair)
                                                            ( 63 . double_quote)
                                                            ( 64 . tagpair_value_contents)
                                                            ( 65 . double_quote)
                                                            ( 66 . tagpair_delimiter_close)
                                                            ( 67 . header)
                                                            ( 68 . tagpair_delimiter_open)
                                                            ( 69 . tagpair_key)
                                                            ( 70 . tagpair_key)
                                                            ( 71 . tagpair_key)
                                                            ( 72 . tagpair_key)
                                                            ( 73 . tagpair_key)
                                                            ( 74 . tagpair)
                                                            ( 75 . double_quote)
                                                            ( 76 . tagpair_value_contents)
                                                            ( 77 . double_quote)
                                                            ( 78 . tagpair_delimiter_close)
                                                            ( 79 . header)
                                                            ( 80 . tagpair_delimiter_open)
                                                            ( 81 . tagpair_key)
                                                            ( 82 . tagpair_key)
                                                            ( 83 . tagpair_key)
                                                            ( 84 . tagpair_key)
                                                            ( 85 . tagpair_key)
                                                            ( 86 . tagpair_key)
                                                            ( 87 . tagpair)
                                                            ( 88 . double_quote)
                                                            ( 89 . tagpair_value_contents)
                                                            ( 90 . double_quote)
                                                            ( 91 . tagpair_delimiter_close)
                                                            ( 92 . header)
                                                            ( 93 . tagpair_delimiter_open)
                                                            ( 94 . tagpair_key)
                                                            ( 95 . tagpair_key)
                                                            ( 96 . tagpair_key)
                                                            ( 97 . tagpair_key)
                                                            ( 98 . tagpair_key)
                                                            ( 99 . tagpair)
                                                            (100 . double_quote)
                                                            (101 . tagpair_value_contents)
                                                            (102 . double_quote)
                                                            (103 . tagpair_delimiter_close)
                                                            (104 . header)
                                                            (105 . tagpair_delimiter_open)
                                                            (106 . tagpair_key)
                                                            (107 . tagpair_key)
                                                            (108 . tagpair_key)
                                                            (109 . tagpair)
                                                            (110 . double_quote)
                                                            (111 . tagpair_value_contents)
                                                            (112 . tagpair_value_contents)
                                                            (113 . tagpair_value_contents)
                                                            (114 . tagpair_value_contents)
                                                            (115 . tagpair_value_contents)
                                                            (116 . tagpair_value_contents)
                                                            (117 . tagpair_value_contents)
                                                            (118 . tagpair_value_contents)
                                                            (119 . tagpair_value_contents)
                                                            (120 . tagpair_value_contents)
                                                            (121 . tagpair_value_contents)
                                                            (122 . tagpair_value_contents)
                                                            (123 . tagpair_value_contents)
                                                            (124 . tagpair_value_contents)
                                                            (125 . tagpair_value_contents)
                                                            (126 . tagpair_value_contents)
                                                            (127 . tagpair_value_contents)
                                                            (128 . tagpair_value_contents)
                                                            (129 . tagpair_value_contents)
                                                            (130 . tagpair_value_contents)
                                                            (131 . tagpair_value_contents)
                                                            (132 . tagpair_value_contents)
                                                            (133 . tagpair_value_contents)
                                                            (134 . tagpair_value_contents)
                                                            (135 . tagpair_value_contents)
                                                            (136 . tagpair_value_contents)
                                                            (137 . tagpair_value_contents)
                                                            (138 . tagpair_value_contents)
                                                            (139 . tagpair_value_contents)
                                                            (140 . tagpair_value_contents)
                                                            (141 . tagpair_value_contents)
                                                            (142 . tagpair_value_contents)
                                                            (143 . tagpair_value_contents)
                                                            (144 . tagpair_value_contents)
                                                            (145 . tagpair_value_contents)
                                                            (146 . tagpair_value_contents)
                                                            (147 . tagpair_value_contents)
                                                            (148 . tagpair_value_contents)
                                                            (149 . tagpair_value_contents)
                                                            (150 . tagpair_value_contents)
                                                            (151 . tagpair_value_contents)
                                                            (152 . tagpair_value_contents)
                                                            (153 . tagpair_value_contents)
                                                            (154 . tagpair_value_contents)
                                                            (155 . tagpair_value_contents)
                                                            (156 . tagpair_value_contents)
                                                            (157 . tagpair_value_contents)
                                                            (158 . tagpair_value_contents)
                                                            (159 . tagpair_value_contents)
                                                            (160 . tagpair_value_contents)
                                                            (161 . tagpair_value_contents)
                                                            (162 . tagpair_value_contents)
                                                            (163 . tagpair_value_contents)
                                                            (164 . tagpair_value_contents)
                                                            (165 . tagpair_value_contents)
                                                            (166 . tagpair_value_contents)
                                                            (167 . tagpair_value_contents)
                                                            (168 . tagpair_value_contents)
                                                            (169 . tagpair_value_contents)
                                                            (170 . tagpair_value_contents)
                                                            (171 . tagpair_value_contents)
                                                            (172 . tagpair_value_contents)
                                                            (173 . double_quote)
                                                            (174 . tagpair_delimiter_close)
                                                            (175 . game)
                                                            (176 . game)
                                                            (177 . move_number)
                                                            (178 . move_number)
                                                            (179 . move_number)
                                                            (180 . movetext)
                                                            (181 . san_move)
                                                            (182 . san_move)
                                                            (183 . san_move)
                                                            (184 . check_or_mate_condition)
                                                            (185 . movetext)
                                                            (186 . san_move)
                                                            (187 . san_move)
                                                            (188 . san_move)
                                                            (189 . movetext)
                                                            (190 . variation_delimiter_open)
                                                            (191 . move_number)
                                                            (192 . move_number)
                                                            (193 . move_number)
                                                            (194 . move_number)
                                                            (195 . move_number)
                                                            (196 . variation_movetext)
                                                            (197 . san_move)
                                                            (198 . san_move)
                                                            (199 . san_move)
                                                            (200 . variation_movetext)
                                                            (201 . variation_delimiter_open)
                                                            (202 . move_number)
                                                            (203 . move_number)
                                                            (204 . move_number)
                                                            (205 . variation_movetext)
                                                            (206 . san_move)
                                                            (207 . san_move)
                                                            (208 . san_move)
                                                            (209 . san_move)
                                                            (210 . variation_movetext)
                                                            (211 . san_move)
                                                            (212 . san_move)
                                                            (213 . san_move)
                                                            (214 . variation_delimiter_close)
                                                            (215 . variation_delimiter_close)
                                                            ;; debatable node "game"
                                                            (216 . game)
                                                            (217 . result_code)
                                                            (218 . series_of_games)
                                                            (219 . series_of_games)))

(setq pygn-mode-test-is-recursive-variation-at-pos '((  1 . nil)
                                                     (  2 . nil)
                                                     (  3 . nil)
                                                     (  4 . nil)
                                                     (  5 . nil)
                                                     (  6 . nil)
                                                     (  7 . nil)
                                                     (  8 . nil)
                                                     (  9 . nil)
                                                     ( 10 . nil)
                                                     ( 11 . nil)
                                                     ( 12 . nil)
                                                     ( 13 . nil)
                                                     ( 14 . nil)
                                                     ( 15 . nil)
                                                     ( 16 . nil)
                                                     ( 17 . nil)
                                                     ( 18 . nil)
                                                     ( 19 . nil)
                                                     ( 20 . nil)
                                                     ( 21 . nil)
                                                     ( 22 . nil)
                                                     ( 23 . nil)
                                                     ( 24 . nil)
                                                     ( 25 . nil)
                                                     ( 26 . nil)
                                                     ( 27 . nil)
                                                     ( 28 . nil)
                                                     ( 29 . nil)
                                                     ( 30 . nil)
                                                     ( 31 . nil)
                                                     ( 32 . nil)
                                                     ( 33 . nil)
                                                     ( 34 . nil)
                                                     ( 35 . nil)
                                                     ( 36 . nil)
                                                     ( 37 . nil)
                                                     ( 38 . nil)
                                                     ( 39 . nil)
                                                     ( 40 . nil)
                                                     ( 41 . nil)
                                                     ( 42 . nil)
                                                     ( 43 . nil)
                                                     ( 44 . nil)
                                                     ( 45 . nil)
                                                     ( 46 . nil)
                                                     ( 47 . nil)
                                                     ( 48 . nil)
                                                     ( 49 . nil)
                                                     ( 50 . nil)
                                                     ( 51 . nil)
                                                     ( 52 . nil)
                                                     ( 53 . nil)
                                                     ( 54 . nil)
                                                     ( 55 . nil)
                                                     ( 56 . nil)
                                                     ( 57 . nil)
                                                     ( 58 . nil)
                                                     ( 59 . nil)
                                                     ( 60 . nil)
                                                     ( 61 . nil)
                                                     ( 62 . nil)
                                                     ( 63 . nil)
                                                     ( 64 . nil)
                                                     ( 65 . nil)
                                                     ( 66 . nil)
                                                     ( 67 . nil)
                                                     ( 68 . nil)
                                                     ( 69 . nil)
                                                     ( 70 . nil)
                                                     ( 71 . nil)
                                                     ( 72 . nil)
                                                     ( 73 . nil)
                                                     ( 74 . nil)
                                                     ( 75 . nil)
                                                     ( 76 . nil)
                                                     ( 77 . nil)
                                                     ( 78 . nil)
                                                     ( 79 . nil)
                                                     ( 80 . nil)
                                                     ( 81 . nil)
                                                     ( 82 . nil)
                                                     ( 83 . nil)
                                                     ( 84 . nil)
                                                     ( 85 . nil)
                                                     ( 86 . nil)
                                                     ( 87 . nil)
                                                     ( 88 . nil)
                                                     ( 89 . nil)
                                                     ( 90 . nil)
                                                     ( 91 . nil)
                                                     ( 92 . nil)
                                                     ( 93 . nil)
                                                     ( 94 . nil)
                                                     ( 95 . nil)
                                                     ( 96 . nil)
                                                     ( 97 . nil)
                                                     ( 98 . nil)
                                                     ( 99 . nil)
                                                     (100 . nil)
                                                     (101 . nil)
                                                     (102 . nil)
                                                     (103 . nil)
                                                     (104 . nil)
                                                     (105 . nil)
                                                     (106 . nil)
                                                     (107 . nil)
                                                     (108 . nil)
                                                     (109 . nil)
                                                     (110 . nil)
                                                     (111 . nil)
                                                     (112 . nil)
                                                     (113 . nil)
                                                     (114 . nil)
                                                     (115 . nil)
                                                     (116 . nil)
                                                     (117 . nil)
                                                     (118 . nil)
                                                     (119 . nil)
                                                     (120 . nil)
                                                     (121 . nil)
                                                     (122 . nil)
                                                     (123 . nil)
                                                     (124 . nil)
                                                     (125 . nil)
                                                     (126 . nil)
                                                     (127 . nil)
                                                     (128 . nil)
                                                     (129 . nil)
                                                     (130 . nil)
                                                     (131 . nil)
                                                     (132 . nil)
                                                     (133 . nil)
                                                     (134 . nil)
                                                     (135 . nil)
                                                     (136 . nil)
                                                     (137 . nil)
                                                     (138 . nil)
                                                     (139 . nil)
                                                     (140 . nil)
                                                     (141 . nil)
                                                     (142 . nil)
                                                     (143 . nil)
                                                     (144 . nil)
                                                     (145 . nil)
                                                     (146 . nil)
                                                     (147 . nil)
                                                     (148 . nil)
                                                     (149 . nil)
                                                     (150 . nil)
                                                     (151 . nil)
                                                     (152 . nil)
                                                     (153 . nil)
                                                     (154 . nil)
                                                     (155 . nil)
                                                     (156 . nil)
                                                     (157 . nil)
                                                     (158 . nil)
                                                     (159 . nil)
                                                     (160 . nil)
                                                     (161 . nil)
                                                     (162 . nil)
                                                     (163 . nil)
                                                     (164 . nil)
                                                     (165 . nil)
                                                     (166 . nil)
                                                     (167 . nil)
                                                     (168 . nil)
                                                     (169 . nil)
                                                     (170 . nil)
                                                     (171 . nil)
                                                     (172 . nil)
                                                     (173 . nil)
                                                     (174 . nil)
                                                     (175 . nil)
                                                     (176 . nil)
                                                     (177 . nil)
                                                     (178 . nil)
                                                     (179 . nil)
                                                     (180 . nil)
                                                     (181 . nil)
                                                     (182 . nil)
                                                     (183 . nil)
                                                     (184 . nil)
                                                     (185 . nil)
                                                     (186 . nil)
                                                     (187 . nil)
                                                     (188 . nil)
                                                     (189 . nil)
                                                     (190 . nil)
                                                     (191 . nil)
                                                     (192 . nil)
                                                     (193 . nil)
                                                     (194 . nil)
                                                     (195 . nil)
                                                     (196 . nil)
                                                     (197 . nil)
                                                     (198 . nil)
                                                     (199 . nil)
                                                     (200 . nil)
                                                     (201 . recursive_variation)
                                                     (202 . recursive_variation)
                                                     (203 . recursive_variation)
                                                     (204 . recursive_variation)
                                                     (205 . recursive_variation)
                                                     (206 . recursive_variation)
                                                     (207 . recursive_variation)
                                                     (208 . recursive_variation)
                                                     (209 . recursive_variation)
                                                     (210 . recursive_variation)
                                                     (211 . recursive_variation)
                                                     (212 . recursive_variation)
                                                     (213 . recursive_variation)
                                                     (214 . recursive_variation)
                                                     (215 . nil)
                                                     (216 . nil)
                                                     (217 . nil)
                                                     (218 . nil)
                                                     (219 . nil)))

(setq pygn-mode-test-lan-moves-closest-named-node-at-pos '((  1 . tagpair_delimiter_open)
                                                           (  2 . tagpair_key)
                                                           (  3 . tagpair_key)
                                                           (  4 . tagpair_key)
                                                           (  5 . tagpair_key)
                                                           (  6 . tagpair_key)
                                                           (  7 . tagpair)
                                                           (  8 . double_quote)
                                                           (  9 . tagpair_value_contents)
                                                           ( 10 . double_quote)
                                                           ( 11 . tagpair_delimiter_close)
                                                           ( 12 . header)
                                                           ( 13 . tagpair_delimiter_open)
                                                           ( 14 . tagpair_key)
                                                           ( 15 . tagpair_key)
                                                           ( 16 . tagpair_key)
                                                           ( 17 . tagpair_key)
                                                           ( 18 . tagpair)
                                                           ( 19 . double_quote)
                                                           ( 20 . tagpair_value_contents)
                                                           ( 21 . double_quote)
                                                           ( 22 . tagpair_delimiter_close)
                                                           ( 23 . header)
                                                           ( 24 . tagpair_delimiter_open)
                                                           ( 25 . tagpair_key)
                                                           ( 26 . tagpair_key)
                                                           ( 27 . tagpair_key)
                                                           ( 28 . tagpair_key)
                                                           ( 29 . tagpair)
                                                           ( 30 . double_quote)
                                                           ( 31 . tagpair_value_contents)
                                                           ( 32 . tagpair_value_contents)
                                                           ( 33 . tagpair_value_contents)
                                                           ( 34 . tagpair_value_contents)
                                                           ( 35 . tagpair_value_contents)
                                                           ( 36 . tagpair_value_contents)
                                                           ( 37 . tagpair_value_contents)
                                                           ( 38 . tagpair_value_contents)
                                                           ( 39 . tagpair_value_contents)
                                                           ( 40 . tagpair_value_contents)
                                                           ( 41 . double_quote)
                                                           ( 42 . tagpair_delimiter_close)
                                                           ( 43 . header)
                                                           ( 44 . tagpair_delimiter_open)
                                                           ( 45 . tagpair_key)
                                                           ( 46 . tagpair_key)
                                                           ( 47 . tagpair_key)
                                                           ( 48 . tagpair_key)
                                                           ( 49 . tagpair_key)
                                                           ( 50 . tagpair)
                                                           ( 51 . double_quote)
                                                           ( 52 . tagpair_value_contents)
                                                           ( 53 . double_quote)
                                                           ( 54 . tagpair_delimiter_close)
                                                           ( 55 . header)
                                                           ( 56 . tagpair_delimiter_open)
                                                           ( 57 . tagpair_key)
                                                           ( 58 . tagpair_key)
                                                           ( 59 . tagpair_key)
                                                           ( 60 . tagpair_key)
                                                           ( 61 . tagpair_key)
                                                           ( 62 . tagpair)
                                                           ( 63 . double_quote)
                                                           ( 64 . tagpair_value_contents)
                                                           ( 65 . double_quote)
                                                           ( 66 . tagpair_delimiter_close)
                                                           ( 67 . header)
                                                           ( 68 . tagpair_delimiter_open)
                                                           ( 69 . tagpair_key)
                                                           ( 70 . tagpair_key)
                                                           ( 71 . tagpair_key)
                                                           ( 72 . tagpair_key)
                                                           ( 73 . tagpair_key)
                                                           ( 74 . tagpair)
                                                           ( 75 . double_quote)
                                                           ( 76 . tagpair_value_contents)
                                                           ( 77 . double_quote)
                                                           ( 78 . tagpair_delimiter_close)
                                                           ( 79 . header)
                                                           ( 80 . tagpair_delimiter_open)
                                                           ( 81 . tagpair_key)
                                                           ( 82 . tagpair_key)
                                                           ( 83 . tagpair_key)
                                                           ( 84 . tagpair_key)
                                                           ( 85 . tagpair_key)
                                                           ( 86 . tagpair_key)
                                                           ( 87 . tagpair)
                                                           ( 88 . double_quote)
                                                           ( 89 . tagpair_value_contents)
                                                           ( 90 . double_quote)
                                                           ( 91 . tagpair_delimiter_close)
                                                           ( 92 . header)
                                                           ( 93 . tagpair_delimiter_open)
                                                           ( 94 . tagpair_key)
                                                           ( 95 . tagpair_key)
                                                           ( 96 . tagpair_key)
                                                           ( 97 . tagpair_key)
                                                           ( 98 . tagpair_key)
                                                           ( 99 . tagpair)
                                                           (100 . double_quote)
                                                           (101 . tagpair_value_contents)
                                                           (102 . double_quote)
                                                           (103 . tagpair_delimiter_close)
                                                           (104 . header)
                                                           (105 . tagpair_delimiter_open)
                                                           (106 . tagpair_key)
                                                           (107 . tagpair_key)
                                                           (108 . tagpair_key)
                                                           (109 . tagpair)
                                                           (110 . double_quote)
                                                           (111 . tagpair_value_contents)
                                                           (112 . tagpair_value_contents)
                                                           (113 . tagpair_value_contents)
                                                           (114 . tagpair_value_contents)
                                                           (115 . tagpair_value_contents)
                                                           (116 . tagpair_value_contents)
                                                           (117 . tagpair_value_contents)
                                                           (118 . tagpair_value_contents)
                                                           (119 . tagpair_value_contents)
                                                           (120 . tagpair_value_contents)
                                                           (121 . tagpair_value_contents)
                                                           (122 . tagpair_value_contents)
                                                           (123 . tagpair_value_contents)
                                                           (124 . tagpair_value_contents)
                                                           (125 . tagpair_value_contents)
                                                           (126 . tagpair_value_contents)
                                                           (127 . tagpair_value_contents)
                                                           (128 . tagpair_value_contents)
                                                           (129 . tagpair_value_contents)
                                                           (130 . tagpair_value_contents)
                                                           (131 . tagpair_value_contents)
                                                           (132 . tagpair_value_contents)
                                                           (133 . tagpair_value_contents)
                                                           (134 . tagpair_value_contents)
                                                           (135 . tagpair_value_contents)
                                                           (136 . tagpair_value_contents)
                                                           (137 . tagpair_value_contents)
                                                           (138 . tagpair_value_contents)
                                                           (139 . tagpair_value_contents)
                                                           (140 . tagpair_value_contents)
                                                           (141 . tagpair_value_contents)
                                                           (142 . tagpair_value_contents)
                                                           (143 . tagpair_value_contents)
                                                           (144 . tagpair_value_contents)
                                                           (145 . tagpair_value_contents)
                                                           (146 . tagpair_value_contents)
                                                           (147 . tagpair_value_contents)
                                                           (148 . tagpair_value_contents)
                                                           (149 . tagpair_value_contents)
                                                           (150 . tagpair_value_contents)
                                                           (151 . tagpair_value_contents)
                                                           (152 . tagpair_value_contents)
                                                           (153 . tagpair_value_contents)
                                                           (154 . tagpair_value_contents)
                                                           (155 . tagpair_value_contents)
                                                           (156 . tagpair_value_contents)
                                                           (157 . tagpair_value_contents)
                                                           (158 . tagpair_value_contents)
                                                           (159 . tagpair_value_contents)
                                                           (160 . tagpair_value_contents)
                                                           (161 . tagpair_value_contents)
                                                           (162 . tagpair_value_contents)
                                                           (163 . tagpair_value_contents)
                                                           (164 . tagpair_value_contents)
                                                           (165 . tagpair_value_contents)
                                                           (166 . tagpair_value_contents)
                                                           (167 . tagpair_value_contents)
                                                           (168 . tagpair_value_contents)
                                                           (169 . tagpair_value_contents)
                                                           (170 . tagpair_value_contents)
                                                           (171 . tagpair_value_contents)
                                                           (172 . tagpair_value_contents)
                                                           (173 . double_quote)
                                                           (174 . tagpair_delimiter_close)
                                                           (175 . game)
                                                           (176 . game)
                                                           (177 . move_number)
                                                           (178 . move_number)
                                                           (179 . move_number)
                                                           (180 . movetext)
                                                           (181 . san_move)
                                                           (182 . san_move)
                                                           (183 . san_move)
                                                           (184 . check_or_mate_condition)
                                                           (185 . movetext)
                                                           (186 . san_move)
                                                           (187 . san_move)
                                                           (188 . san_move)
                                                           (189 . movetext)
                                                           (190 . move_number)
                                                           (191 . move_number)
                                                           (192 . move_number)
                                                           (193 . movetext)
                                                           (194 . lan_move)
                                                           (195 . lan_move)
                                                           (196 . lan_move)
                                                           (197 . lan_move)
                                                           (198 . lan_move)
                                                           (199 . movetext)
                                                           (200 . lan_move)
                                                           (201 . lan_move)
                                                           (202 . lan_move)
                                                           (203 . lan_move)
                                                           (204 . lan_move)
                                                           (205 . movetext)
                                                           (206 . move_number)
                                                           (207 . move_number)
                                                           (208 . move_number)
                                                           (209 . movetext)
                                                           (210 . san_move)
                                                           (211 . san_move)
                                                           (212 . san_move)
                                                           (213 . movetext)
                                                           (214 . san_move)
                                                           (215 . san_move)
                                                           (216 . san_move)
                                                            ;; debatable node "game"
                                                           (217 . game)
                                                           (218 . result_code)
                                                           (219 . series_of_games)
                                                           (220 . series_of_games)))

(defmacro pygn-mode-test-with-file (filename &rest body)
  "Evaluate BODY in a `pygn-mode' temp buffer filled with the contents of FILENAME."
  (declare (indent 1))
  `(with-temp-buffer
     (let ((coding-system-for-read 'utf-8))
       (insert-file-contents
        (expand-file-name ,filename pygn-mode-test-input-directory)))
     (goto-char (point-min))
     (pygn-mode)
     ,@body))

;;; pygn-mode-pgn-at-pos

;; (ert-deftest pygn-mode-pgn-at-pos-01 nil
;;   "Test `pygn-mode-pgn-at-pos' from the first position (a corner case)."
;;   (pygn-mode-test-with-file "test-01.pgn"
;;     (should (equal
;;              "[Event \"?\"]\n"
;;              (pygn-mode-pgn-at-pos (point-min))))))

;; (ert-deftest pygn-mode-pgn-at-pos-02 nil
;;   "Test `pygn-mode-pgn-at-pos' string from every move-start position (test-01.pgn)."
;;   (pygn-mode-test-with-file "test-01.pgn"
;;     (dolist (cell pygn-mode-test-01-move-start-positions)
;;       (let* ((moves          (car cell))
;;              (move-pos       (cdr cell))
;;              (move-after-pos (cdr (assoc moves pygn-mode-test-01-move-after-positions))))
;;         (goto-char (point-min))
;;         (pygn-mode-next-move moves)
;;         (should (= (length (pygn-mode-pgn-at-pos (point)))
;;                    (1- move-after-pos)))))))

(ert-deftest pygn-mode-pgn-at-pos-03 nil
  "Test `pygn-mode-pgn-at-pos' interpreted as a FEN from every move-start position (test-01.pgn)."
  (pygn-mode-test-with-file "test-01.pgn"
    (dolist (cell pygn-mode-test-01-move-start-positions)
      (let* ((moves        (car cell))
             (move-pos     (cdr cell))
             (fen-for-move (cdr (assoc moves pygn-mode-test-01-move-fens))))
        (goto-char (point-min))
        (pygn-mode-next-move moves)
        (should (equal (pygn-mode-pgn-to-fen (pygn-mode-pgn-at-pos (point)))
                       fen-for-move))))))

(ert-deftest pygn-mode-pgn-at-pos-04 nil
  "Test `pygn-mode-pgn-at-pos' exhaustively, from every position in the buffer which follows a move (test-01.pgn)."
  (pygn-mode-test-with-file "test-01.pgn"
    (let ((last-pos (point-max)))

      ;; TODO: this merely hides a bug in pygn-mode-pgn-at-pos
      (goto-char last-pos)
      (skip-syntax-backward "-")
      (forward-char -1)
      (setq last-pos (point))

      (dolist (cell (reverse pygn-mode-test-01-move-start-positions))
        (let* ((moves              (car cell))
               (move-pos           (cdr cell))
               (fen-for-move       (cdr (assoc moves pygn-mode-test-01-move-fens)))
               (trailing-positions (number-sequence last-pos move-pos -1)))
          (dolist (pos trailing-positions)
            (should (stringp (pygn-mode-pgn-at-pos pos)))
            (should (equal (pygn-mode-pgn-to-fen (pygn-mode-pgn-at-pos pos))
                           fen-for-move)))
          (setq last-pos (1- move-pos)))))))

;; (ert-deftest pygn-mode-pgn-at-pos-05 nil
;;   "Test `pygn-mode-pgn-at-pos' string from every move-start position (test-02.pgn)."
;;   (pygn-mode-test-with-file "test-02.pgn"
;;     (dolist (cell pygn-mode-test-02-move-start-positions)
;;       (let* ((moves          (car cell))
;;              (move-pos       (cdr cell))
;;              (move-after-pos (cdr (assoc moves pygn-mode-test-02-move-after-positions))))
;;         (goto-char (point-min))
;;         (pygn-mode-next-move moves)
;;         (should (= (length (pygn-mode-pgn-at-pos (point)))
;;                    (1- move-after-pos)))))))

(ert-deftest pygn-mode-pgn-at-pos-06 nil
  "Test `pygn-mode-pgn-at-pos' interpreted as a FEN from every move-start position (test-02.pgn)."
  (pygn-mode-test-with-file "test-02.pgn"
    (dolist (cell pygn-mode-test-02-move-start-positions)
      (let* ((moves        (car cell))
             (move-pos     (cdr cell))
             (fen-for-move (cdr (assoc moves pygn-mode-test-02-move-fens))))
        (goto-char (point-min))
        (pygn-mode-next-move moves)
        (should (equal (pygn-mode-pgn-to-fen (pygn-mode-pgn-at-pos (point)))
                       fen-for-move))))))

(ert-deftest pygn-mode-pgn-at-pos-07 nil
  "Test `pygn-mode-pgn-at-pos' exhaustively, from every position in the buffer which follows a move (test-02.pgn)."
  (pygn-mode-test-with-file "test-02.pgn"
    (let ((last-pos (point-max)))

      (dolist (cell (reverse pygn-mode-test-02-move-start-positions))
        (let* ((moves              (car cell))
               (move-pos           (cdr cell))
               (fen-for-move       (cdr (assoc moves pygn-mode-test-02-move-fens)))
               (trailing-positions (number-sequence last-pos move-pos -1)))
          (dolist (pos trailing-positions)
            (should (stringp (pygn-mode-pgn-at-pos pos)))
            (should (equal (pygn-mode-pgn-to-fen (pygn-mode-pgn-at-pos pos))
                           fen-for-move)))
          (setq last-pos (1- move-pos)))))))

;;; pygn-mode-next-move

(ert-deftest pygn-mode-next-move-01 nil
  "Test `pygn-mode-next-move' from `point-min' to first move."
  (pygn-mode-test-with-file "test-01.pgn"
    (pygn-mode-next-move)
    (should (= (point)
               (cdr (assoc 1 pygn-mode-test-01-move-start-positions))))))

(ert-deftest pygn-mode-next-move-02 nil
  "Test two successive calls to `pygn-mode-next-move'."
  (pygn-mode-test-with-file "test-01.pgn"
    (pygn-mode-next-move)
    (pygn-mode-next-move)
    (should (= (point)
               (cdr (assoc 2 pygn-mode-test-01-move-start-positions))))))

(ert-deftest pygn-mode-next-move-03 nil
  "Test integer ARG to `pygn-mode-next-move'."
  (pygn-mode-test-with-file "test-01.pgn"
    (pygn-mode-next-move 2)
    (should (= (point)
               (cdr (assoc 2 pygn-mode-test-01-move-start-positions))))))

(ert-deftest pygn-mode-next-move-04 nil
  "Test negative integer ARG to `pygn-mode-next-move'."
  (pygn-mode-test-with-file "test-01.pgn"
    (pygn-mode-next-move 2)
    (pygn-mode-next-move -1)
    (should (= (point)
               (cdr (assoc 1 pygn-mode-test-01-move-start-positions))))))

(ert-deftest pygn-mode-next-move-05 nil
  "Test `pygn-mode-next-move' for every ARG which leads to a move (test-01.pgn)."
  (pygn-mode-test-with-file "test-01.pgn"
    (dolist (cell pygn-mode-test-01-move-start-positions)
      (let ((moves    (car cell))
            (move-pos (cdr cell)))
        (goto-char (point-min))
        (pygn-mode-next-move moves)
        (should (= (point) move-pos))))))

(ert-deftest pygn-mode-next-move-06 nil
  "Test `pygn-mode-next-move' exhaustively, from every position in the buffer which precedes a move (test-01.pgn)."
  (pygn-mode-test-with-file "test-01.pgn"
    (let ((last-pos (point-min)))
      (dolist (cell pygn-mode-test-01-move-start-positions)
        (let* ((moves             (car cell))
               (move-pos          (cdr cell))
               (leading-positions (number-sequence last-pos (1- move-pos))))
          (dolist (pos leading-positions)
            (goto-char pos)
            (pygn-mode-next-move)
            (should (= (point) move-pos)))
          (setq last-pos move-pos))))))

(ert-deftest pygn-mode-next-move-07 nil
  "Test `pygn-mode-next-move' for every ARG which leads to a move (test-02.pgn)."
  (pygn-mode-test-with-file "test-02.pgn"
    (dolist (cell pygn-mode-test-02-move-start-positions)
      (let ((moves    (car cell))
            (move-pos (cdr cell)))
        (goto-char (point-min))
        (pygn-mode-next-move moves)
        (should (= (point) move-pos))))))

(ert-deftest pygn-mode-next-move-08 nil
  "Test `pygn-mode-next-move' exhaustively, from every position in the buffer which precedes a move (test-02.pgn)."
  (pygn-mode-test-with-file "test-02.pgn"
    (let ((last-pos (point-min)))
      (dolist (cell pygn-mode-test-02-move-start-positions)
        (let* ((moves             (car cell))
               (move-pos          (cdr cell))
               (leading-positions (number-sequence last-pos (1- move-pos))))
          (dolist (pos leading-positions)
            (goto-char pos)
            (pygn-mode-next-move)
            (should (= (point) move-pos)))
          (setq last-pos move-pos))))))

(ert-deftest pygn-mode-next-move-09 nil
  "Test that `pygn-mode-next-move' errors from the last move."
  (pygn-mode-test-with-file "test-01.pgn"
    (let* ((cell     (car (last pygn-mode-test-01-move-start-positions)))
           (moves    (car cell))
           (move-pos (cdr cell)))
      (pygn-mode-next-move moves)
      (should-error (pygn-mode-next-move)))))

(ert-deftest pygn-mode-next-move-10 nil
  "Test that `pygn-mode-next-move' errors from every position after the last move."
  (pygn-mode-test-with-file "test-01.pgn"
    (let* ((cell     (car (last pygn-mode-test-01-move-start-positions)))
           (moves    (car cell))
           (move-pos (cdr cell))
           (trailing-positions (number-sequence move-pos (point-max))))
      (dolist (pos trailing-positions)
        (goto-char pos)
        (should-error (pygn-mode-next-move))))))

;; TODO pygn-mode-next-move behavior when between games

;;; pygn-mode-previous-move

(ert-deftest pygn-mode-previous-move-01 nil
  "Test `pygn-mode-previous-move' from second move to first move."
  (pygn-mode-test-with-file "test-01.pgn"
    (pygn-mode-next-move 2)
    (pygn-mode-previous-move)
    (should (= (point)
               (cdr (assoc 1 pygn-mode-test-01-move-start-positions))))
    (should (looking-at-p "Qe8\\+\\>"))))

(ert-deftest pygn-mode-previous-move-02 nil
  "Test integer ARG to `pygn-mode-previous-move'."
  (pygn-mode-test-with-file "test-01.pgn"
    (pygn-mode-next-move 3)
    (pygn-mode-previous-move 2)
    (should (= (point)
               (cdr (assoc 1 pygn-mode-test-01-move-start-positions))))))

(ert-deftest pygn-mode-previous-move-03 nil
  "Test negative ARG to `pygn-mode-previous-move', which should advance the position."
  (pygn-mode-test-with-file "test-01.pgn"
    (pygn-mode-previous-move -2)
    (should (= (point)
               (cdr (assoc 2 pygn-mode-test-01-move-start-positions))))))

(ert-deftest pygn-mode-previous-move-04 nil
  "Test `pygn-mode-previous-move' for every ARG which leads to a move (test-01.pgn)."
  (pygn-mode-test-with-file "test-01.pgn"
    (dolist (cell (reverse pygn-mode-test-01-move-start-positions))
      (let ((moves    (car cell))
            (move-pos (cdr cell))
            (rescaler (1+ (length pygn-mode-test-01-move-start-positions))))
        (setq moves (- rescaler moves))
        (goto-char (point-max))
        (pygn-mode-previous-move moves)
        (should (= (point) move-pos))))))

(ert-deftest pygn-mode-previous-move-05 nil
  "Test `pygn-mode-previous-move' exhaustively, from every position in the buffer which follows a move (test-01.pgn)."
  (pygn-mode-test-with-file "test-01.pgn"
    (let ((last-pos (point-max)))
      (dolist (cell (reverse pygn-mode-test-01-move-start-positions))
        (let* ((moves              (car cell))
               (move-pos           (cdr cell))
               (trailing-positions (number-sequence last-pos (1+ move-pos) -1)))
          (dolist (pos trailing-positions)
            (goto-char pos)
            (pygn-mode-previous-move)
            (should (= (point) move-pos)))
          (setq last-pos move-pos))))))

(ert-deftest pygn-mode-previous-move-06 nil
  "Test `pygn-mode-previous-move' for every ARG which leads to a move (test-02.pgn)."
  (pygn-mode-test-with-file "test-02.pgn"
    (dolist (cell (reverse pygn-mode-test-02-move-start-positions))
      (let ((moves    (car cell))
            (move-pos (cdr cell))
            (rescaler (1+ (length pygn-mode-test-02-move-start-positions))))
        (setq moves (- rescaler moves))
        (goto-char (point-max))
        (pygn-mode-previous-move moves)
        (should (= (point) move-pos))))))

(ert-deftest pygn-mode-previous-move-07 nil
  "Test `pygn-mode-previous-move' exhaustively, from every position in the buffer which follows a move (test-02.pgn)."
  (pygn-mode-test-with-file "test-02.pgn"
    (let ((last-pos (point-max)))
      (dolist (cell (reverse pygn-mode-test-02-move-start-positions))
        (let* ((moves              (car cell))
               (move-pos           (cdr cell))
               (trailing-positions (number-sequence last-pos (1+ move-pos) -1)))
          (dolist (pos trailing-positions)
            (goto-char pos)
            (pygn-mode-previous-move)
            (should (= (point) move-pos)))
          (setq last-pos move-pos))))))

(ert-deftest pygn-mode-previous-move-08 nil
  "Test that `pygn-mode-previous-move' errors from the first move."
  (pygn-mode-test-with-file "test-01.pgn"
    (pygn-mode-next-move)
    (should-error (pygn-mode-previous-move))))

(ert-deftest pygn-mode-previous-move-09 nil
  "Test that `pygn-mode-previous-move' errors from every position before the first move."
  (pygn-mode-test-with-file "test-01.pgn"
    (let* ((cell     (car pygn-mode-test-01-move-start-positions))
           (moves    (car cell))
           (move-pos (cdr cell))
           (leading-positions (number-sequence (point-min) move-pos)))
      (dolist (pos leading-positions)
        (goto-char pos)
        (should-error (pygn-mode-previous-move))))))

;; TODO pygn-mode-previous-move behavior when between games

;;; pygn-mode-next-game

(ert-deftest pygn-mode-next-game-01 nil
  "Test `pygn-mode-next-game' from `point-min' to second game."
  (pygn-mode-test-with-file "test-03.pgn"
    (pygn-mode-next-game)
    (should (= (point)
               (cdr (assoc 2 pygn-mode-test-03-game-start-positions))))))

(ert-deftest pygn-mode-next-game-02 nil
  "Test two successive calls to `pygn-mode-next-game'."
  (pygn-mode-test-with-file "test-03.pgn"
    (pygn-mode-next-game)
    (pygn-mode-next-game)
    (should (= (point)
               (cdr (assoc 3 pygn-mode-test-03-game-start-positions))))))

(ert-deftest pygn-mode-next-game-03 nil
  "Test integer ARG to `pygn-mode-next-game'."
  (pygn-mode-test-with-file "test-03.pgn"
    (pygn-mode-next-game 2)
    (should (= (point)
               (cdr (assoc 3 pygn-mode-test-03-game-start-positions))))))

(ert-deftest pygn-mode-next-game-04 nil
  "Test negative integer ARG to `pygn-mode-next-game'."
  (pygn-mode-test-with-file "test-03.pgn"
    (pygn-mode-next-game 2)
    (pygn-mode-next-game -1)
    (should (= (point)
               (cdr (assoc 2 pygn-mode-test-03-game-start-positions))))))

(ert-deftest pygn-mode-next-game-05 nil
  "Test `pygn-mode-next-game' for every ARG which leads to a game (test-03.pgn)."
  (pygn-mode-test-with-file "test-03.pgn"
    (dolist (cell pygn-mode-test-03-game-start-positions)
      (let ((games    (car cell))
            (game-pos (cdr cell)))
        (goto-char (point-min))
        (pygn-mode-next-game (1- games))
        (should (= (point) game-pos))))))

(ert-deftest pygn-mode-next-game-06 nil
  "Test `pygn-mode-next-game' exhaustively, from every position in the buffer which precedes a game (test-03.pgn)."
  (pygn-mode-test-with-file "test-03.pgn"
    (let ((last-pos (point-min)))
      (dolist (cell pygn-mode-test-03-game-start-positions)
        (let* ((games             (car cell))
               (game-pos          (cdr cell))
               (leading-positions (number-sequence last-pos (1- game-pos))))
          (dolist (pos leading-positions)
            (goto-char pos)
            (pygn-mode-next-game)
            (should (= (point) game-pos)))
          (setq last-pos game-pos))))))

(ert-deftest pygn-mode-next-game-07 nil
  "Test that `pygn-mode-next-game' errors from the last game start."
  (pygn-mode-test-with-file "test-03.pgn"
    (let* ((cell     (car (last pygn-mode-test-03-game-start-positions)))
           (games    (car cell))
           (game-pos (cdr cell)))
      (pygn-mode-next-game (1- games))
      (should-error (pygn-mode-next-game)))))

(ert-deftest pygn-mode-next-game-08 nil
  "Test that `pygn-mode-next-game' errors from every position after the last game start."
  (pygn-mode-test-with-file "test-03.pgn"
    (let* ((cell     (car (last pygn-mode-test-03-game-start-positions)))
           (games    (car cell))
           (game-pos (cdr cell))
           (trailing-positions (number-sequence game-pos (point-max))))
      (dolist (pos trailing-positions)
        (goto-char pos)
        (should-error (pygn-mode-next-game))))))

;; TODO pygn-mode-next-game behavior when between games

;;; pygn-mode-previous-game

(ert-deftest pygn-mode-previous-game-01 nil
  "Test `pygn-mode-previous-game' from `point-min' to second game, back to first game."
  (pygn-mode-test-with-file "test-03.pgn"
    (pygn-mode-next-game)
    (pygn-mode-previous-game)
    (should (= (point)
               (cdr (assoc 1 pygn-mode-test-03-game-start-positions))))))

(ert-deftest pygn-mode-previous-game-02 nil
  "Test two successive calls to `pygn-mode-previous-game'."
  (pygn-mode-test-with-file "test-03.pgn"
    (pygn-mode-next-game 3)
    (pygn-mode-previous-game)
    (pygn-mode-previous-game)
    (should (= (point)
               (cdr (assoc 2 pygn-mode-test-03-game-start-positions))))))

(ert-deftest pygn-mode-previous-game-03 nil
  "Test integer ARG to `pygn-mode-previous-game'."
  (pygn-mode-test-with-file "test-03.pgn"
    (pygn-mode-next-game 3)
    (pygn-mode-previous-game 2)
    (should (= (point)
               (cdr (assoc 2 pygn-mode-test-03-game-start-positions))))))

(ert-deftest pygn-mode-previous-game-04 nil
  "Test negative integer ARG to `pygn-mode-previous-game'."
  (pygn-mode-test-with-file "test-03.pgn"
    (pygn-mode-next-game 2)
    (pygn-mode-previous-game -1)
    (should (= (point)
               (cdr (assoc 4 pygn-mode-test-03-game-start-positions))))))

(ert-deftest pygn-mode-previous-game-05 nil
  "Test `pygn-mode-previous-game' for every ARG which leads to a game (test-03.pgn)."
  (pygn-mode-test-with-file "test-03.pgn"
    (dolist (cell (reverse pygn-mode-test-03-game-start-positions))
      (let ((games    (car cell))
            (game-pos (cdr cell))
            (rescaler (length pygn-mode-test-03-game-start-positions)))
        (setq games (- rescaler games))
        (goto-char (cdr (car (last pygn-mode-test-03-game-start-positions))))
        (pygn-mode-previous-game games)
        (should (= (point) game-pos))))))

;; TODO: the save-excursions are needed because the behavior of
;; pygn-mode-previous-game when between games is not well defined.
(ert-deftest pygn-mode-previous-game-06 nil
  "Test `pygn-mode-previous-game' exhaustively, from every position in the buffer which follows a game (test-03.pgn)."
  (pygn-mode-test-with-file "test-03.pgn"
    (let ((last-pos (save-excursion
                      (goto-char (point-max))
                      (skip-syntax-backward "-")
                      (forward-char -1)
                      (point))))
      (dolist (cell (reverse (cdr pygn-mode-test-03-game-start-positions)))
        (let* ((games              (car cell))
               (game-pos           (cdr cell))
               (previous-game      (1- games))
               (previous-game-pos  (cdr (assoc previous-game pygn-mode-test-03-game-start-positions)))
               (trailing-positions (number-sequence last-pos game-pos -1)))
          (dolist (pos trailing-positions)
            (goto-char pos)
            (pygn-mode-previous-game)
            (should (= (point) previous-game-pos)))
          (setq last-pos (save-excursion
                           (goto-char game-pos)
                           (skip-syntax-backward "-")
                           (forward-char -1)
                           (point))))))))

(ert-deftest pygn-mode-previous-game-07 nil
  "Test that `pygn-mode-previous-game' errors from the first game start."
  (pygn-mode-test-with-file "test-03.pgn"
    (let* ((cell     (car pygn-mode-test-03-game-start-positions))
           (games    (car cell))
           (game-pos (cdr cell)))
      (goto-char game-pos)
      (should-error (pygn-mode-previous-game)))))

(ert-deftest pygn-mode-previous-game-08 nil
  "Test that `pygn-mode-previous-game' errors from every position in the first game."
  (pygn-mode-test-with-file "test-03.pgn"
    (let* ((cell     (car pygn-mode-test-03-game-start-positions))
           (games    (car cell))
           (game-pos (cdr cell))
           (second-cell (car (cadr pygn-mode-test-03-game-start-positions)))
           (second-game-pos (cdr cell))
           (positions (number-sequence game-pos (1- second-game-pos))))
      (dolist (pos positions)
        (goto-char pos)
        (should-error (pygn-mode-previous-game))))))

;; TODO pygn-mode-previous-game behavior when between games

;;; pygn-mode--true-containing-node

(ert-deftest pygn-mode--true-containing-node-01 nil
  "Test `pygn-mode--true-containing-node' exhaustively, for closest named node on position in the buffer (test-01.pgn)."
  (pygn-mode-test-with-file "test-01.pgn"
    (dolist (cell pygn-mode-test-01-closest-named-node-at-pos)
      (let ((pos        (car cell))
            (node-type  (cdr cell)))
        (should (eq (tsc-node-type (pygn-mode--true-containing-node nil pos))
                    node-type))))))

(ert-deftest pygn-mode--true-containing-node-02 nil
  "Test `pygn-mode--true-containing-node' exhaustively, for closest named node on position in the buffer (test-recursive-variation.pgn)."
  (pygn-mode-test-with-file "test-recursive-variation.pgn"
    (dolist (cell pygn-mode-test-recursive-closest-named-node-at-pos)
      (let ((pos        (car cell))
            (node-type  (cdr cell)))
        (should (eq (tsc-node-type (pygn-mode--true-containing-node nil pos))
                    node-type))))))

(ert-deftest pygn-mode--true-containing-node-03 nil
  "Test `pygn-mode--true-containing-node' exhaustively, checking for a recursive_variation node on position in the buffer (test-recursive-variation.pgn)."
  (pygn-mode-test-with-file "test-recursive-variation.pgn"
    (dolist (cell pygn-mode-test-is-recursive-variation-at-pos)
      (let ((pos        (car cell))
            (node-type  (cdr cell)))
        (when-let (node (pygn-mode--true-containing-node 'recursive_variation pos))
          (should (eq (tsc-node-type node) node-type)))))))

(ert-deftest pygn-mode--true-containing-node-04 nil
  "Test `pygn-mode--true-containing-node' exhaustively, for closest named node on position in the buffer (test-lan-moves.pgn)."
  (pygn-mode-test-with-file "test-lan-moves.pgn"
    (dolist (cell pygn-mode-test-lan-moves-closest-named-node-at-pos)
      (let ((pos        (car cell))
            (node-type  (cdr cell)))
        (should (eq (tsc-node-type (pygn-mode--true-containing-node nil pos))
                    node-type))))))

;;
;; Emacs
;;
;; Local Variables:
;; coding: utf-8
;; byte-compile-warnings: (not cl-functions)
;; End:
;;

;;; pygn-mode-test.el ends here
